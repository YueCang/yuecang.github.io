<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Elasticsearch</title>
    <link href="/2023/12/22/Elasticsearch/"/>
    <url>/2023/12/22/Elasticsearch/</url>
    
    <content type="html"><![CDATA[<h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>首先引用 Elasticsearch （下文简称 ES）<a href="https://www.elastic.co/cn/elasticsearch/">官网</a>的一段描述：</p><blockquote><p>Elasticsearch 是一个分布式、RESTful 风格的<strong>搜索和数据分析引擎</strong>，能够解决不断涌现出的各种用例。 作为 Elastic Stack 的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。</p></blockquote><h2 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h2><ul><li><p>安装包下载</p><ul><li><a href="https://mirrors.huaweicloud.com/elasticsearch/">华为镜像站</a> 国内下载快速</li><li><a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch">官方-Past Releases</a> 速度比较慢</li></ul></li><li><p>下面的步骤参考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html">Set up Elasticsearch » Installing Elasticsearch » Install Elasticsearch from archive on Linux or MacOS</a>，选择的安装包是 elasticsearch-7.3.0 版本 </p><ul><li><pre><code class="shell"># 下载安装包wget https://mirrors.huaweicloud.com/elasticsearch/7.3.0/elasticsearch-7.3.0-linux-x86_64.tar.gzwget https://mirrors.huaweicloud.com/elasticsearch/7.3.0/elasticsearch-7.3.0-linux-x86_64.tar.gz.sha512# 验证安装包的完整性，如果没问题，会输出 OKshasum -a 512 -c elasticsearch-7.3.0-linux-x86_64.tar.gz.sha512tar -xzf elasticsearch-7.3.0-linux-x86_64.tar.gz# 将目录复制三份，作为三个节点，后面配置 ES 集群时，对应了三个 ES 实例cp -R elasticsearch-7.3.0 es-7.3.0-node-1cp -R elasticsearch-7.3.0 es-7.3.0-node-2mv elasticsearch-7.3.0 es-7.3.0-node-3# 因为以 root 用户启动不了ES，需要将文件属主改成es用户,并且用es用户启动chown -R es es-7.3.0*# ======================== 文件结构 ============================├── bin # 二进制脚本存放目录，包括 elasticsearch 来指定运行一个 node，包括 elasticsearch-plugin 来安装 plugins├── config # 包含了 elasticsearch.yml 配置文件├── data # 节点上分配的每个 index/分片 的数据文件├── lib├── LICENSE.txt├── logs├── modules├── NOTICE.txt├── plugins # 插键文件存放的位置└── README.textile<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>- 运行Elasticsearch<br><br>  - ~~~shell<br>    <span class="hljs-comment"># 启动es，日志在 $ES_HOME/logs 目录中</span><br>    .<span class="hljs-regexp">/bin/</span>elasticsearch<br>    <br>    <span class="hljs-comment"># 如果要将 ES 作为守护程序运行，请在命令行中指定 -d，指定 -p 参数，将进程 ID 记录到 pid 文件</span><br>    .<span class="hljs-regexp">/bin/</span>elasticsearch -d -p pid<br>    <br>    <span class="hljs-comment"># 如果要停止 ES，运行如下的命令</span><br>    pkill -F pid<br></code></pre></td></tr></table></figure></code></pre></li></ul></li><li><p>检查运行状态</p><ul><li><pre><code class="shell"># 服务器查看运行状态curl -X GET &quot;localhost:9200/?pretty&quot;# 浏览器中查看运行状态,访问 localhost:9200 &#123;    &quot;name&quot;: &quot;node-1&quot;,    &quot;cluster_name&quot;: &quot;appsearch-7.3.2&quot;,    &quot;cluster_uuid&quot;: &quot;GlzI_v__QJ2s9ewAgomOqg&quot;,    &quot;version&quot;: &#123;        &quot;number&quot;: &quot;7.3.0&quot;,        &quot;build_flavor&quot;: &quot;default&quot;,        &quot;build_type&quot;: &quot;tar&quot;,        &quot;build_hash&quot;: &quot;de777fa&quot;,        &quot;build_date&quot;: &quot;2019-07-24T18:30:11.767338Z&quot;,        &quot;build_snapshot&quot;: false,        &quot;lucene_version&quot;: &quot;8.1.0&quot;,        &quot;minimum_wire_compatibility_version&quot;: &quot;6.8.0&quot;,        &quot;minimum_index_compatibility_version&quot;: &quot;6.0.0-beta1&quot;    &#125;,    &quot;tagline&quot;: &quot;You Know, for Search&quot;&#125;<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>  - `Notes：` 如果你是在远端服务器上部署的 ES，那么，此时在你本地的工作机上还无法调通 **IP:<span class="hljs-number">9200</span>**，需要对 ES 进行相关配置才能访问，下文会介绍 <br><br><span class="hljs-comment">## ES相关配置</span><br><br>- 配置文件主要位于 `<span class="hljs-variable">$ES_HOME</span>/config` 目录下）<br>  - `elasticsearch.yml` ES 的配置，[more](https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/im</span>portant-settings.html)<br>  - `jvm.options` ES JVM 配置，[more](https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/</span>jvm-options.html<span class="hljs-comment">#jvm-options)</span><br>  - `log4j2.properties` ES 日志配置，[more](https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/</span>logging.html<span class="hljs-comment">#logging)</span><br>- JVM配置<br>  -  [JVM 参数设置](https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/</span>jvm-options.html<span class="hljs-comment">#jvm-options)可以通过 `jvm.options` 文件</span><br>  - `<span class="hljs-variable">$ES_HOME</span><span class="hljs-regexp">/config/</span>jvm.options` 当通过 `tar` or `zip` 包安装<br>  - `<span class="hljs-regexp">/etc/</span>elasticsearch/jvm.options` 当通过 Debian or RPM packages<br><br>- 官网也介绍了如何[设置堆大小](https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/guide/</span>en<span class="hljs-regexp">/elasticsearch/</span>reference<span class="hljs-regexp">/current/</span>heap-size.html)。<br><br>  默认情况，ES 告诉 JVM 使用一个最小和最大都为 <span class="hljs-number">1</span>GB 的堆。但是到了生产环境，这个配置就比较重要了，确保 ES 有足够堆空间可用。<br><br>  ES 使用 `Xms(minimum heap size)` 和 `Xmx(maxmimum heap size)` 设置堆大小。你应该将这两个值设为同样的大小。<br><br>  **`Xms` 和 `Xmx` 不能大于你物理机内存的 <span class="hljs-number">50</span>%。**<br><br>  - ~~~shell<br>    -Xms2g <br>    -Xmx2g<br></code></pre></td></tr></table></figure></code></pre></li></ul></li><li><p>elasticsearch.yml配置</p><p> ES 默认会加载位于 <code>$ES_HOME/config/elasticsearch.yml</code> 的配置文件</p><p> 备注：任何能够通过配置文件设置的内容，都可以通过命令行使用 <code>-E</code> 的语法进行指定，例如： </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./bin/elasticsearch -d -Ecluster.name=my_cluster -Enode.name=node_1<br></code></pre></td></tr></table></figure><ul><li><p>cluster.name</p><p> <code>cluster.name</code> 设置<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster.name.html">集群名称</a>。一个节点只能加入一个集群中，默认的集群名称是 <code>elasticsearch</code> </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 确保节点的集群名称要设置正确，这样才能加入到同一个集群中</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">search-7.3.2</span><br></code></pre></td></tr></table></figure></li><li><p>node.name</p><p> <code>node.name</code>：可以配置每个<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/node.name.html">节点的名称</a>。用来提供可读性高的 ES 实例名称，它默认名称是机器的 <code>hostname</code>，可以自定义： </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 同一集群中的节点名称不能相同</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">node-1</span><br></code></pre></td></tr></table></figure></li><li><p>network.host</p><p> <code>network.host</code>：设置访问的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/network.host.html">地址</a>。默认仅绑定在回环地址 <code>127.0.0.1</code> 和 <code>[::1]</code>。如果需要从其他服务器上访问以及多态机器搭建集群，我们需要设定 ES 运行绑定的 Host，节点需要绑定非回环的地址。建议设置为主机的公网 IP 或 <code>0.0.0.0</code>： </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure><p> 更多的网络设置可以阅读 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html">Network Settings</a> </p></li><li><p>http.port</p><p> <code>http.port</code> 默认端口是 9200 ： </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 这是指 http 端口，如果采用 REST API 对接 ES，那么就是采用的 http 协议</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9200</span><br></code></pre></td></tr></table></figure></li><li><p>transport.prot</p><p> REST 客户端通过 HTTP 将请求发送到您的 Elasticsearch 集群，但是接收到客户端请求的节点不能总是单独处理它，通常必须将其传递给其他节点以进行进一步处理。它使用传输网络层（transport networking layer）执行此操作。传输层用于集群中节点之间的所有内部通信，与远程集群节点的所有通信，以及 Elasticsearch Java API 中的 TransportClient </p><p> <code>transport.port</code> 绑定端口范围。默认为 9300-9400 </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 因为要在一台机器上创建是三个 ES 实例，这里明确指定每个实例的端口</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9300</span><br></code></pre></td></tr></table></figure></li><li><p>discovery.seed_hosts</p><p> <code>discovery.seed_hosts</code>：发现设置。有两种重要的发现和集群形成配置，以便集群中的节点能够彼此发现并且选择一个主节点。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-settings.html">官网&#x2F;Important discovery and cluster formation settings</a> </p><p> <code>discovery.seed_hosts</code> 是组件集群时比较重要的配置，用于启动当前节点时，发现其他节点的初始列表。</p></li></ul></li></ul><h2 id="创建ES集群"><a href="#创建ES集群" class="headerlink" title="创建ES集群"></a>创建ES集群</h2><p> 分别明确指定了这些实例的 <code>http.port</code> 和 <code>transport.port</code>。**<code>discovery.seed_hosts</code>**明确指定实例的端口对测试集群的高可用性很关键 </p><p> 如果后期有新节点加入，新节点的 <code>discovery.seed_hosts</code> 没必要包含所有的节点，只要它里面包含集群中已有的节点信息，新节点就能发现整个集群</p><ul><li><p>集群配置</p><ul><li>分别进入<code>es-7.3.0-node-1</code>、<code>es-7.3.0-node-2</code> 和 <code>es-7.3.0-node-3</code> 的文件夹，<code>config/elasticsearch.yml</code> 设置如下：</li></ul>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># es-7.3.0-node-1，node-1 节点仅仅是一个 master 节点，它不是一个数据节点</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">search-7.3.2</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">node-1</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">node.ingest:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9200</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9300</span><br><span class="hljs-attr">discovery.seed_hosts:</span> [<span class="hljs-string">&quot;127.0.0.1:9300&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9301&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9302&quot;</span>]<br><span class="hljs-attr">cluster.initial_master_nodes:</span> [<span class="hljs-string">&quot;node-1&quot;</span>]<br><br><span class="hljs-comment"># es-7.3.0-node-2</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">search-7.3.2</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">node-2</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">node.ingest:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9201</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9301</span><br><span class="hljs-attr">discovery.seed_hosts:</span> [<span class="hljs-string">&quot;127.0.0.1:9300&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9301&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9302&quot;</span>]<br><br><span class="hljs-comment"># es-7.3.0-node-3</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">search-7.3.2</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">node-3</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">node.ingest:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9202</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9302</span><br><span class="hljs-attr">discovery.seed_hosts:</span> [<span class="hljs-string">&quot;127.0.0.1:9300&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9301&quot;</span>,<span class="hljs-string">&quot;127.0.0.1:9302&quot;</span>]<br></code></pre></td></tr></table></figure><ul><li><pre><code class="shell"># 经过上面的配置，可以通过命令 egrep -v &quot;^#|^$&quot; config/elasticsearch.yml 检查配置项# 先启动 node-1 节点，因为它设置了初始主节点的列表。这时候就可以使用 http://&lt;host IP&gt;:9200/ 看到结果了。然后逐一启动 node-2 和 node-3。通过访问 http://127.0.0.1:9200/_cat/nodes 查看集群是否 OK# http://127.0.0.1:9200/_nodes 将会显示节点更多的详情信息192.168.3.112 25 87 13 4.29   dm - node-3192.168.3.112 26 87 16 4.29   dm - node-2192.168.3.112 35 87 16 4.29   m  * node-1<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim"><br>- 启动时相关问题<br><br>  - 问题<span class="hljs-number">1</span>：<span class="hljs-built_in">max</span> virtual memory areas <span class="hljs-keyword">vm</span>.max_map_count [<span class="hljs-number">65530</span>] <span class="hljs-keyword">is</span> too low, increase <span class="hljs-keyword">to</span> at least [<span class="hljs-number">262144</span>]<br>  <br>    ~~~<span class="hljs-keyword">shell</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;vm.max_map_count=262144&quot;</span> &gt; /etc/sysctl.<span class="hljs-keyword">conf</span><br>    sysctl -<span class="hljs-keyword">p</span><br></code></pre></td></tr></table></figure></code></pre></li><li><p>问题2：max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo vim /etc/security/limits.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">加入以下内容</span><br>* soft nofile 300000<br>* hard nofile 300000<br>* soft nproc 102400<br>* soft memlock unlimited<br>* hard memlock unlimited<br></code></pre></td></tr></table></figure></li><li><p>问题3：master_not_discovered_exception</p><blockquote><p> 主节点指定的名字要保证存在，别指定了不存在的节点名。</p></blockquote></li></ul></li></ul><h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><ul><li><pre><code class="shell"># 安装插件./bin/elasticsearch-plugin install analysis-icu# 如果安装插件速度慢，可以先下载，载安装wget https://artifacts.elastic.co/downloads/elasticsearch-plugins/analysis-icu/analysis-icu-7.3.0.zip./bin/elasticsearch-plugin install file://file path Of analysis-icu-7.1.0.zip<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br><span class="hljs-comment">## 安装Kibana</span><br><br> **Kibana 是通向 Elastic 产品集的窗口。 它可以在 Elasticsearch 中对数据进行视觉探索和实时分析** <br><br>- Kibanna版本一定要和ES版本一致 [Download]( https:<span class="hljs-regexp">//</span>www.elastic.co<span class="hljs-regexp">/cn/</span>downloads/past-releases<span class="hljs-comment">#kibana )</span><br><br>- 下载后解压启动即可<br><br>  ~~~shell<br>  <span class="hljs-comment"># 启动Kibanna</span><br>  <span class="hljs-regexp">/bin/</span>kibanna<br></code></pre></td></tr></table></figure></code></pre></li><li><p>Kibanna汉化</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 在config/kibana.yml 配置文件中添加以下配置，重启即可</span><br><span class="hljs-attr">il8n.locale:</span> <span class="hljs-string">&quot;zh-CN&quot;</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="Elasticsearch安装可视化（head插件）"><a href="#Elasticsearch安装可视化（head插件）" class="headerlink" title="Elasticsearch安装可视化（head插件）"></a>Elasticsearch安装可视化（head插件）</h2><ul><li><p>使用插件的前提需要安装node.js 和 npm</p><ul><li><p>下载地址： <a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a> </p></li><li><pre><code class="shell">D:\ES\elasticsearch-head-master\elasticsearch-head-master&gt; node -vv14.17.5D:\ES\elasticsearch-head-master\elasticsearch-head-master&gt;npm -v 6.14.14<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-bullet">-</span> 插件下载地址： https://github.com/mobz/elasticsearch-head <br><br><span class="hljs-bullet">  -</span> cd elasticsearch-head-master<br><span class="hljs-bullet">  -</span>  npm install <br><span class="hljs-bullet">  -</span>  npm run start <br><span class="hljs-bullet">  -</span>  <span class="hljs-code">`open`</span> http://localhost:9100/ <br><br><span class="hljs-bullet">-</span> 注意跨域问题（跨端口、跨网站、跨ip）<br><br><span class="hljs-bullet">  -</span> 打开http://localhost:9100/，显示<span class="hljs-code">`集群健康值：未连接`</span>有可能是因为跨域问题<br><br><span class="hljs-bullet">    -</span> 解决方法在ES的配置文件<span class="hljs-code">`elasticsearch.yml`</span>中添加相关配置，重新启动ES<br><br><span class="hljs-code">    ~~~yml</span><br><span class="hljs-code">    http.cors.enabled: true</span><br><span class="hljs-code">    http.cors.allow-origin: &quot;*&quot;</span><br></code></pre></td></tr></table></figure></code></pre></li></ul></li></ul><h2 id="理论-使用"><a href="#理论-使用" class="headerlink" title="理论&amp;使用"></a>理论&amp;使用</h2><h3 id="1-1-安装"><a href="#1-1-安装" class="headerlink" title="1.1 安装"></a>1.1 安装</h3><ul><li>略</li></ul><blockquote><p><code>Notes:</code>9300端口为ES组件内部通信端口，9200端口为浏览器访问的Restful端口。</p><p>安装完成后，打开：http:localhost:9200</p></blockquote><h3 id="1-2-倒排索引"><a href="#1-2-倒排索引" class="headerlink" title="1.2 倒排索引"></a>1.2 倒排索引</h3><p>理解倒排索引，首先要明白正向索引</p><ul><li><p>正向索引</p><p>正向索引是按照id创建索引，进行查询，对于内容的查询并不友好</p><table><thead><tr><th>id</th><th>context</th></tr></thead><tbody><tr><td>1001</td><td>my name is zhang san</td></tr><tr><td>1002</td><td>my name is li si</td></tr><tr><td>1003</td><td>my name is zhang qiang</td></tr></tbody></table></li><li><p>倒排索引</p><p>将context字段中的内容进行分词，根据分词进行索引排布</p><table><thead><tr><th>keyboard</th><th>id</th></tr></thead><tbody><tr><td>my</td><td>1001，1002，1003</td></tr><tr><td>name</td><td>1001，1002，1003</td></tr><tr><td>is</td><td>1001，1002，1003</td></tr><tr><td>zhang</td><td>1001，1003</td></tr><tr><td>san</td><td>1001</td></tr><tr><td>li</td><td>1002</td></tr><tr><td>qiang</td><td>1003</td></tr></tbody></table></li></ul><h3 id="1-3-ES基本操作"><a href="#1-3-ES基本操作" class="headerlink" title="1.3 ES基本操作"></a>1.3 ES基本操作</h3><h4 id="1-3-1-索引相关（增查删）"><a href="#1-3-1-索引相关（增查删）" class="headerlink" title="1.3.1 索引相关（增查删）"></a>1.3.1 索引相关（增查删）</h4><blockquote><p>使用<strong>put请求</strong>，创建索引</p><p><a href="http://183.255.40.99:19200/lyb-test02">http://183.255.40.99:19200/lyb-test02</a></p></blockquote><blockquote><p>使用<strong>get请求</strong>，获取所有索引，参数v表示展示详细信息</p><p><a href="http://183.255.40.99:19200/_cat/indices?v">http://183.255.40.99:19200/_cat/indices?v</a></p></blockquote><blockquote><p>使用<strong>delete请求</strong>，删除索引</p><p><a href="http://183.255.40.99:19200/lyb-test">http://183.255.40.99:19200/lyb-test</a></p></blockquote><blockquote><p><strong>put请求</strong>，设置mapping，类似于数据库中针对字段进行定义</p><p><a href="http://183.255.40.99:19200/user-test/_mapping">http://183.255.40.99:19200/user-test/_mapping</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体</span><br><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-comment">// 字段名称</span><br>         <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 字段类型，text可分词</span><br>         <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 是否可以被索引到</span><br>     <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 字段类型，keyword不可分词</span><br>         <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>     <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;tel&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>     <span class="hljs-punctuation">&#125;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>get请求</strong>，获取mapping信息</p><p><a href="http://183.255.40.99:19200/user-test/_mapping">http://183.255.40.99:19200/user-test/_mapping</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 返回结果</span><br><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;user-test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>             <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                 <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>             <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>             <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                 <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>             <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>             <span class="hljs-attr">&quot;tel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                 <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                 <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>             <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">&#125;</span><br>     <span class="hljs-punctuation">&#125;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="1-3-2-文档相关（增查改删）"><a href="#1-3-2-文档相关（增查改删）" class="headerlink" title="1.3.2 文档相关（增查改删）"></a>1.3.2 文档相关（增查改删）</h4><ul><li><p>插入文档</p><blockquote><p>使用<strong>post请求</strong>，进行文档的添加，向请求体（body）中添加json格式的数据，不指定id，默认随机生成：</p><p><a href="http://183.255.40.99:19200/lyb-test02/_doc">http://183.255.40.99:19200/lyb-test02/_doc</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">18</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5AXFc4MB8EUHiDi5WypO&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">576</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>可以使用指定id的请求：<a href="http://183.255.40.99:19200/lyb-test02/_doc/1001">http://183.255.40.99:19200/lyb-test02/_doc/1001</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">20</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>返回结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&gt;<span class="hljs-punctuation">&#123;</span><br>&gt;<span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>&gt;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">577</span><span class="hljs-punctuation">,</span><br>&gt;<span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>&gt;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></blockquote></li><li><p>文档查询</p><blockquote><p>获取文档（get）：</p><ul><li><p>指定id获取：<a href="http://183.255.40.99:19200/lyb-test02/_doc/1001">http://183.255.40.99:19200/lyb-test02/_doc/1001</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>不指定id，查询所有文档：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6QXPc4MB8EUHiDi56SrJ&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul></blockquote></li><li><p>更新文档</p><blockquote><p>更新文档：</p><ul><li><p>全字段进行覆盖更新（put）：<a href="http://183.255.40.99:19200/lyb-test02/_doc/1001">http://183.255.40.99:19200/lyb-test02/_doc/1001</a></p><p><strong>put可以理解为全量覆盖更新，必须指定id，source由原来的两个字段变为了一个</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json">操作前，source存在两个字段<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br>操作后，source只存在put时的字段<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>使用post请求进行局部字段更新：<a href="http://183.255.40.99:19200/lyb-test02/_update/1001">http://183.255.40.99:19200/lyb-test02/_update/1001</a></p><p>只针对对应字段进行更新</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs json">进行操作前：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br>进行操作后：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><p><code>Notes：</code></p><ol><li>PUT会将新的json值完全替换掉旧的；而POST方式只会更新相同字段的值，其他数据不会改变，新提交的字段若不存在则增加。</li><li>PUT和DELETE操作是幂等的。所谓幂等是指不管进行多少次操作，结果都一样。比如用PUT修改一篇文章，然后在做同样的操作，每次操作后的结果并没有什么不同，DELETE也是一样。POST操作不是幂等的，比如常见的POST重复加载问题：当我们多次发出同样的POST请求后，其结果是创建了若干的资源。</li></ol></blockquote></li><li><p>删除文档</p><blockquote><p>删除操作（delete）：<a href="http://183.255.40.99:19200/lyb-test02/_doc/1001">http://183.255.40.99:19200/lyb-test02/_doc/1001</a></p><p>操作结果：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;deleted&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></blockquote></li><li><p>search操作</p><blockquote><ul><li><p>全量查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p></li><li><p>条件查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs json">请求体：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;sex&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br>请求结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">872</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>分页查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;from&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>针对_source进行控制的查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><p>_source字段控制显示的字段</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;user&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>针对某一字段排序：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;user&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;age&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;desc&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-number">19</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-number">19</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-number">18</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>多条件查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><ul><li><p>must（且）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;must&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;18&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;man&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.4700036</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>should（或）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;should&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;18&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;man&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.4700036</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>filter</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;should&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;18&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;man&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;gt&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">18</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4700036</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>全文检索：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><ul><li><p>match</p><p><strong>match会将查询条件进行分词，从而查询</strong></p><p>即，查询条件满足：zhang、si、zhang si的均会被查询出来</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;zhang si&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">242</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.3862942</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1004&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.3862942</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6931471</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6931471</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>match_phrase</p><p><strong>进行精准的匹配，查询条件不会进行分词查询</strong></p><p>即，查询字段中必须包含完整查询条件，不会将查询条件进行分词匹配</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_phrase&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;zhang si&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>  <br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.3862942</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1004&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.3862942</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>高亮查询：<a href="http://183.255.40.99:19200/lyb-test02/_search">http://183.255.40.99:19200/lyb-test02/_search</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;match_phrase&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;zhang&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果：</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">73</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6931471</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6931471</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                        <span class="hljs-string">&quot;&lt;em&gt;zhang&lt;/em&gt; san&quot;</span><br>                    <span class="hljs-punctuation">]</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1004&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6931471</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                        <span class="hljs-string">&quot;&lt;em&gt;zhang&lt;/em&gt; si&quot;</span><br>                    <span class="hljs-punctuation">]</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>聚合查询</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 请求体</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 聚合操作</span><br>        <span class="hljs-attr">&quot;age_group&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 名称，随意取名</span><br>            <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;age&quot;</span> <span class="hljs-comment">//分组字段</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span> <span class="hljs-comment">// 添加上以后不会显示原始数据，可加可不加</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 返回结果</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">46</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang san&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wang wu&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;man&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lyb-test02&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1004&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang si&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;woman&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;aggregations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;age_group&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;buckets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;doc_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;doc_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">66</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;doc_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul></blockquote></li></ul><h3 id="1-4-Java-API"><a href="#1-4-Java-API" class="headerlink" title="1.4 Java API"></a>1.4 Java API</h3><blockquote><p>ES 7.15以后，<strong>Rest-High-Level-Client 标记为弃用状态，开始使用ES JAVA API Client</strong>，8.x版本开启兼容后，仍然可继续使用，没有任何其他系统开销</p><p>官方高级客户端操作文档：<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.17/java-rest-high-getting-started.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.17/java-rest-high-getting-started.html</a></p></blockquote><h4 id="1-4-1-MAVEN依赖"><a href="#1-4-1-MAVEN依赖" class="headerlink" title="1.4.1 MAVEN依赖"></a>1.4.1 MAVEN依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.17.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.17.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="1-4-2-JAVA-API"><a href="#1-4-2-JAVA-API" class="headerlink" title="1.4.2 JAVA API"></a>1.4.2 JAVA API</h4><ul><li><p>创建高级客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建 low level client</span><br><span class="hljs-type">RestClientBuilder</span> <span class="hljs-variable">restClientBuilder</span> <span class="hljs-operator">=</span> RestClient.builder(<span class="hljs-keyword">new</span><br>                                                         <span class="hljs-title class_">HttpHost</span>(<span class="hljs-string">&quot;183.255.40.99&quot;</span>, <span class="hljs-number">19200</span>));<br><br><span class="hljs-comment">// 创建 high level client</span><br><span class="hljs-type">RestHighLevelClient</span> <span class="hljs-variable">esClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(restClientBuilder);<br></code></pre></td></tr></table></figure></li><li><p>索引操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Clickhouse</title>
    <link href="/2023/12/22/Clickhouse/"/>
    <url>/2023/12/22/Clickhouse/</url>
    
    <content type="html"><![CDATA[<h1 id="ClickHouse初级"><a href="#ClickHouse初级" class="headerlink" title="ClickHouse初级"></a>ClickHouse初级</h1><p><code>官方存在中文文档</code>( <a href="https://clickhouse.tech/docs/zh/">https://clickhouse.tech/docs/zh/</a> )</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p> ClickHouse是一个用于联机分析(OLAP)的<code>列式数据库管理系统</code>(DBMS) </p><ul><li>常见的行式数据库系统  <code>MySQL</code>、<code>Postgres</code>和<code>MS SQL Server</code></li><li>常见的列式数据库有： Vertica、 Paraccel (Actian Matrix，Amazon Redshift)、 Sybase IQ、 Exasol、 Infobright、 InfiniDB、 MonetDB (VectorWise， Actian Vector)、 LucidDB、 SAP HANA、 Google Dremel、 Google PowerDrill、 Druid、 kdb+</li></ul><h3 id="OLAP场景的关键特征"><a href="#OLAP场景的关键特征" class="headerlink" title="OLAP场景的关键特征 "></a>OLAP场景的关键特征<a href="https://clickhouse.tech/docs/zh/#olapchang-jing-de-guan-jian-te-zheng"> </a></h3><ul><li>绝大多数是读请求</li><li>数据以相当大的批次(&gt; 1000行)更新，而不是单行更新;或者根本没有更新</li><li>已添加到数据库的数据不能修改</li><li>对于读取，从数据库中提取相当多的行，但只提取列的一小部分</li><li>宽表，即每个表包含着大量的列</li><li>查询相对较少(通常每台服务器每秒查询数百次或更少)</li><li>对于简单查询，允许延迟大约50毫秒</li><li>列中的数据相对较小：数字和短字符串(例如，每个URL 60个字节)</li><li>处理单个查询时需要高吞吐量(每台服务器每秒可达数十亿行)</li><li>事务不是必须的</li><li>对数据一致性要求低</li><li>每个查询有一个大表。除了他以外，其他的都很小</li><li>查询结果明显小于源数据。换句话说，数据经过过滤或聚合，因此结果适合于单个服务器的RAM中</li></ul><h2 id="ClickHouse安装"><a href="#ClickHouse安装" class="headerlink" title="ClickHouse安装"></a>ClickHouse安装</h2><h3 id="单机安装"><a href="#单机安装" class="headerlink" title="单机安装"></a>单机安装</h3><ul><li><p>着重注意的几个节点版本</p><ul><li><blockquote><p>20.5版本 —&gt; final</p><p>20.6.3版本 —&gt; explain可以查看sql执行计划，再次之前只能通过日志查看</p><p>20.8版本 —&gt; 添加了库引擎支持实时同步mysql（Canal、Maxwell均支持）</p></blockquote></li></ul></li><li><p>关闭防火墙</p><ul><li><pre><code class="shell"># 查看防火墙状态systemctl status firewalld# 关闭防火墙systemctl stop firewalld# 禁止开机自启systemctl disable firewalld<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stata"><br>- CentOS取消打开文件限制<br><br>  - ~~~<span class="hljs-keyword">shell</span><br>    # 编辑文件根据服务器情况添加以下内容<br>    vim /etc/security/limits.<span class="hljs-keyword">conf</span><br><span class="hljs-comment">    * soft nofile 65536</span><br><span class="hljs-comment">    * hard nofile 65536</span><br><span class="hljs-comment">    * soft nproc 131072</span><br><span class="hljs-comment">    * hard nproc 131072</span><br>    <br>    # limits.<span class="hljs-keyword">d</span>文件夹的配置会覆盖上面那个文件的配置，最好也配置一下，没有20-nproc.<span class="hljs-keyword">conf</span>文件自行创建<br>    vim /etc/security/limits.<span class="hljs-keyword">d</span>/20-nproc.<span class="hljs-keyword">conf</span><br><span class="hljs-comment">    * soft nofile 65536</span><br><span class="hljs-comment">    * hard nofile 65536</span><br><span class="hljs-comment">    * soft nproc 131072</span><br><span class="hljs-comment">    * hard nproc 131072</span><br></code></pre></td></tr></table></figure></code></pre></li></ul></li><li><p>取消SELinux（Security Enforce Linux）</p><ul><li><pre><code class="shell"># 配置后不会立即生效，需要重启服务器，可以临时关闭vim /etc/selinux/configSELINUX=disabled# 临时关闭selinuxsetenforce 0# 获取selinux状态getenforce<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><br>- 使用rpm包离线安装<br><br>  - `需要下载四个rpm包`https:<span class="hljs-comment">//repo.yandex.ru/clickhouse/rpm/stable/x86_64/ </span><br><br>  - ~~~shell<br>    clickhouse-<span class="hljs-keyword">client</span><span class="hljs-number">-21.7</span><span class="hljs-number">.3</span><span class="hljs-number">.14</span><span class="hljs-number">-2.</span>noarch.rpm<br>    clickhouse-<span class="hljs-keyword">common</span>-<span class="hljs-keyword">static</span><span class="hljs-number">-21.7</span><span class="hljs-number">.3</span><span class="hljs-number">.14</span><span class="hljs-number">-2.</span>x86_64.rpm<br>    clickhouse-<span class="hljs-keyword">server</span><span class="hljs-number">-21.7</span><span class="hljs-number">.3</span><span class="hljs-number">.14</span><span class="hljs-number">-2.</span>noarch.rpm<br>    clickhouse-<span class="hljs-keyword">common</span>-<span class="hljs-keyword">static</span>-dbg<span class="hljs-number">-21.7</span><span class="hljs-number">.3</span><span class="hljs-number">.14</span><span class="hljs-number">-2.</span>x86_64.rpm<br>    <br>    <span class="hljs-meta"># 安装rpm包</span><br>    rpm -ivh *.rpm<br></code></pre></td></tr></table></figure></code></pre></li><li><p>使用rpm安装的默认路径解释</p><table><thead><tr><th>安装路径</th><th>含 义</th></tr></thead><tbody><tr><td>&#x2F;etc&#x2F;</td><td>配置文件安装目录</td></tr><tr><td>&#x2F;usr&#x2F;bin&#x2F;</td><td>可执行的命令安装目录</td></tr><tr><td>&#x2F;usr&#x2F;lib&#x2F;</td><td>程序所使用的函数库保存位置</td></tr><tr><td>&#x2F;usr&#x2F;share&#x2F;doc&#x2F;</td><td>基本的软件使用手册保存位置</td></tr><tr><td>&#x2F;usr&#x2F;share&#x2F;man&#x2F;</td><td>帮助文件保存位置</td></tr></tbody></table></li></ul></li><li><p>开启IPV6</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">将列出的ipv6相关配置更改为0</span><br>vim /etc/sysctl.conf<br>net.ipv6.conf.all.disable_ipv6 = 0<br>net.ipv6.conf.default.disable_ipv6 = 0<br>net.ipv6.conf.lo.disable_ipv6 = 0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将列出的ipv6相关配置更改为0</span><br>vim /etc/modprobe.d/disable_ipv6.conf<br>options ipv6 disable=0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">开启IVP6</span><br>vim /etc/sysconfig/network<br>NETWORKING_IPV6=yes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启网络服务即可</span><br>systemctl restart network<br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><ul><li><p><code>在修改配置后，需要重启clickhouse-server，先关闭，后重启，别直接重启（直接重启可能不会重新加载配置文件），使用以下命令：</code></p></li><li><pre><code class="shell"># 关闭ck服务systemctl stop clickhouse-server# 启动ck服务systemctl start clickhouse-server############################################ 修改配置文件，强制保存   :wq!vim /etc/clickhouse-server/config.xml# 去掉注释，开启远程连接，任意主机都可访问&lt;listen_host&gt;::&lt;/listen_host&gt;# 数据文件路径&lt;path&gt;/var/lib/clickhouse/&lt;/path&gt;# 日志文件路径&lt;log&gt;/var/log/clickhouse-server/clickhouse-server.log&lt;/log&gt;<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><br>- 启动<span class="hljs-keyword">Server</span><br><br>  - ~~~shell<br>    # 启动<span class="hljs-keyword">Server</span><br>    systemctl <span class="hljs-keyword">start</span> clickhouse-<span class="hljs-keyword">server</span><br>    <br>    # 设置开机自启<br>    systemctl <span class="hljs-keyword">enable</span> clickhouse-<span class="hljs-keyword">server</span><br></code></pre></td></tr></table></figure></code></pre></li></ul></li><li><p>启动client</p><ul><li><pre><code class="shell">clickhouse-client -m-m :可以在命令窗口输入多行命令，分号结束命令-h :主机名，访问其他主机的clickhouse-server服务-p :端口<figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="language-xml"></span><br><span class="language-xml">### 集群安装（3节点）</span><br><span class="language-xml"></span><br><span class="language-xml">**安装zk集群，启动zk集群（略）**</span><br><span class="language-xml"></span><br><span class="language-xml">**集群3分片2副本3节点**（不推荐）</span><br><span class="language-xml"></span><br><span class="language-xml">- [3分片2副本3节点，涉及到单节点双实例配置]( https://www.cnblogs.com/linlf03/p/15392198.html )</span><br><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">**集群2分片，其中1分片2副本，1分片1副本**</span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;%</span> <span class="hljs-name">asset_img</span> <span class="hljs-number">1648795270372</span>.png <span class="hljs-number">1648795270372</span> <span class="hljs-template-tag">%&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">- **在/etc/clickhouse-server/config.d创建`metrika.xml`，内容如下**</span><br><span class="language-xml"></span><br><span class="language-xml">  ~~~xml</span><br><span class="language-xml">  <span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">yandex</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">remote_servers</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-comment">&lt;!--集群名称--&gt;</span> </span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">clickhouse_cluster</span>&gt;</span> </span><br><span class="language-xml">              <span class="hljs-comment">&lt;!--集群的第一个分片--&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> </span><br><span class="language-xml">                  <span class="hljs-comment">&lt;!--副本之间内部同步打开--&gt;</span></span><br><span class="language-xml">                  <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span></span><br><span class="language-xml">                  <span class="hljs-comment">&lt;!--该分片的第一个副本--&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> </span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop102<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span></span><br><span class="language-xml">                  <span class="hljs-comment">&lt;!--该分片的第二个副本--&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> </span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-comment">&lt;!--集群的第二个分片--&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> </span><br><span class="language-xml">                   <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> </span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop104<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">                       <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">                   <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">clickhouse_cluster</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">remote_servers</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-comment">&lt;!-- 不同节点需要对应进行修改 --&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">macros</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span>01<span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span> <span class="hljs-comment">&lt;!--不同机器放的分片数不一样--&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span>rep_1_1<span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span> <span class="hljs-comment">&lt;!--不同机器放的副本数不一样--&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">macros</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-comment">&lt;!-- 对外开放所有地址 --&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">networks</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ip</span>&gt;</span>::/0<span class="hljs-tag">&lt;/<span class="hljs-name">ip</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">networks</span>&gt;</span></span><br><span class="language-xml">  </span><br><span class="language-xml">      <span class="hljs-comment">&lt;!-- 数据压缩 --&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">clickhouse_compression</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">case</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">min_part_size</span>&gt;</span>10000000000<span class="hljs-tag">&lt;/<span class="hljs-name">min_part_size</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">min_part_size_ratio</span>&gt;</span>0.01<span class="hljs-tag">&lt;/<span class="hljs-name">min_part_size_ratio</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span>lz4<span class="hljs-tag">&lt;/<span class="hljs-name">method</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">case</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">clickhouse_compression</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">zookeeper-servers</span>&gt;</span></span><br><span class="language-xml">           <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop102<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">           <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span></span><br><span class="language-xml">           <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">           <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;3&quot;</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop104<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span></span><br><span class="language-xml">               <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span></span><br><span class="language-xml">           <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">zookeeper-servers</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">yandex</span>&gt;</span></span><br></code></pre></td></tr></table></figure></code></pre></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--hadoop102--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">macros</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span>01<span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span>rep_1_1<span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">macros</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--hadoop103--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">macros</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span>01<span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span>rep_1_2<span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">macros</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--hadoop104--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">macros</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span>02<span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span>rep_2_1<span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">macros</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>修改文件属主：属组</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chown clickhouse:clickhouse metrika.xml<br></code></pre></td></tr></table></figure></li><li><p><strong>配置&#x2F;etc&#x2F;clickhouse-server&#x2F;config.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 去掉注释，开启远程连接，任意主机都可访问 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">listen_host</span>&gt;</span>::<span class="hljs-tag">&lt;/<span class="hljs-name">listen_host</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 数据文件路径，可修改，可默认 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">path</span>&gt;</span>/var/lib/clickhouse/<span class="hljs-tag">&lt;/<span class="hljs-name">path</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 日志文件路径，默认即可 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">log</span>&gt;</span>/var/log/clickhouse-server/clickhouse-server.log<span class="hljs-tag">&lt;/<span class="hljs-name">log</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 引入外部配置文件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">zookeeper</span> <span class="hljs-attr">incl</span>=<span class="hljs-string">&quot;zookeeper-servers&quot;</span> <span class="hljs-attr">optional</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">include_from</span>&gt;</span>/etc/clickhouse-server/config.d/metrika.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include_from</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>配置完成后启动即可</strong></p></li><li><p><strong>集群是否安装成功</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动任意节点客户端</span><br>clickhouse-client -m<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">出现我们创建集群的集群名称即为配置成功</span><br>hadoop102 :) show clusters;<br>┌─cluster──────────────────────<br>│ clickhouse_cluster                           │<br>│ test_cluster_two_shards                      │<br>│ test_cluster_two_shards_internal_replication │<br>│ test_cluster_two_shards_localhost            │<br>│ test_shard_localhost                         │<br>│ test_shard_localhost_secure                  │<br>│ test_unavailable_shard                       │<br>└───────────────────────────<br></code></pre></td></tr></table></figure></li><li><p><strong>具体集群中创建分布式表的操作跳转分片集群</strong></p></li></ul><h2 id="ClickHouse可视化工具（DBeaver）"><a href="#ClickHouse可视化工具（DBeaver）" class="headerlink" title="ClickHouse可视化工具（DBeaver）"></a>ClickHouse可视化工具（DBeaver）</h2><ul><li><a href="https://dbeaver.io/download/">DBeaver官方下载</a></li><li>按照系统对应安装即可</li></ul><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><ul><li><p><strong>整型</strong></p><p>固定长度的整型，包括有符号整型或无符号整型。 </p><p>整型范围（-2n-1~2n-1-1）： </p><p><strong>clickhouse中的类型 —&gt; 类比java中的类型</strong></p><p>Int8 - [-128 : 127]   —&gt;  byte 8bit</p><p>Int16 - [-32768 : 32767]  —&gt;  short 16bit</p><p>Int32 - [-2147483648 : 2147483647]  —&gt; int 32bit</p><p>Int64 - [-9223372036854775808 : 9223372036854775807]   —&gt;   long 64bit</p><p>无符号整型范围（0~2n-1）： </p><p>UInt8 - [0 : 255] </p><p>UInt16 - [0 : 65535] </p><p>UInt32 - [0 : 4294967295] </p><p>UInt64 - [0 : 18446744073709551615] </p><p><strong>使用场景： 个数、数量、也可以存储型</strong> <strong>id</strong></p></li><li><p><strong>浮点型</strong></p><p>Float32 - float </p><p>Float64 – double </p><p>建议尽可能以整数形式存储数据。例如，将固定精度的数字转换为整数值，如时间用毫秒为单位表示，因为浮点型进行计算时可能引起四舍五入的误差。</p></li><li><p>布尔类型</p><p>没有单独的类型存储布尔值，可以使用UInt8类型，取值限制为0或1</p></li><li><p>Decimal类型</p><p>有符号的浮点数，可在加减和乘法运算过程中保持精度。对于除法，最低有效数字会被丢弃</p><p>三种声明方式：</p><ul><li>decimal32(s),共9位。如：decimal32(5),一共9位，保留5位小数，4位整数</li><li>decimal64(s),共18位。如：decimal32(5),一共9位，保留5位小数，13位整数</li><li>decimal128(s),共38位。如：decimal32(5),一共9位，保留5位小数，33位整数</li></ul></li><li><p>字符串</p><ul><li>String：字符串可以是任意长度，它包含任意字符集，包含空字节</li><li>FixedString(N)：固定长度N的字符串，不够N位，后续空字符补全，超过N位则报错，不常用</li></ul></li><li><p>枚举类型</p><p>包括Enum8和Enum16类型</p><p>创建语法：Enum8(‘hello’&#x3D;1, ‘world’&#x3D;2)</p><ul><li>Enum8：’string’ &#x3D; int8</li><li>Enum16：’string’ &#x3D; int16</li></ul></li><li><p>时间类型</p><ul><li>Date：接收年-月-日的字符串，如：2022-03-16</li><li>Datetime：接收年-月-日 时:分:秒，如：2022-03-16 00:00:00</li><li>Datetime64：接收年-月-日 时:分:秒.亚秒，如：2022-03-16 00:00:00.66</li></ul></li><li><p>数组类型</p><ul><li>Array（T）</li></ul></li><li><p>Nullable</p></li></ul><h2 id="表引擎"><a href="#表引擎" class="headerlink" title="表引擎"></a>表引擎</h2><p>表引擎是clickhouse一大特色</p><ul><li>数据存储的方式和位置，写到哪里以及到哪里读取</li><li>支持那些查询以及如何支持</li><li>并发数据访问</li><li>索引的使用（如果存在）</li><li>是否可以执行多线程请求</li><li>数据复制参数</li></ul><p><code>Notes：引擎的名称大小写敏感</code></p><h3 id="表引擎分类"><a href="#表引擎分类" class="headerlink" title="表引擎分类"></a>表引擎分类</h3><ul><li><p>TinyLog</p><p>以列文件的形式保存在磁盘上，不支持索引，没有并发控制，一般存储少量数据的小表</p></li><li><p>Memory</p><p>内存引擎，数据以未压缩的的原始形式直接保存在内存中，服务器重启就会消失，读写操作不会相互阻塞，不支持索引，简单查询下有非常高的性能表现</p></li><li><p>Intergrations</p><p>外部集成引擎，例如：MySQL的表，将其映射到CK中，直接可以在CK中查询</p></li><li><p>MergeTree</p><p>Clickhouse中最强大的表引擎当属MergeTree引擎以及该系列的*MergeTree中的其他引擎，支持索引和分区，地位相当于innodb之于mysql，基于MergeTree还衍生除了很多非常有特色的引擎</p><p><code>Notes：Order by必填</code></p></li><li><p>ReplacingMergeTree</p><p>ReplacingMergeTree是MergeTree的一个变种，他完全继承了MergeTree，只是多了一个去重功能。<code>如果你想去除掉重复数据，可以使用此表引擎，去重是根据Order by字段进行的，去重不能跨分区，只有同一批数据或合并分区时才会进行去重，认定保留的数据为最大值，若值相同，则按照插入顺序，保留后插入的</code></p><ul><li><p>去重时机</p><p><code>数据去重只会在合并的过程中出现，合并是在后台进行的，你无法预知时间，可能会有一些数据仍然未被处理</code></p></li><li><p>去重范围</p><p>如果表经过多次分区，去重只会在分区内部进行去重，不能执行库跨分区的去重</p></li><li><p>去重解决方案（3种）</p><p>高级部分补充。。。。。。。。。。。。。。。。。。。。。。。。。。。。。。。。。</p></li></ul></li><li><p>SummingMergeTree</p><p>适用于不查询明细数据，只关心维度进行汇总聚合结果的场景，如果只使用MergeTree的话，无论是存储的空间开销，还是查询时临时聚合的开销都比较大，Clickhouse为了应对该场景，提供了该预聚合的引擎</p><ul><li>以表中指定列进行汇总数据列</li><li>列必须为数字列，如不填写，以所有<code>非维度列（非order by字段）</code>且为数字列的字段进行汇总</li><li>以order by的列为准，作为<code>维度列</code></li><li>只用同一批次数据或者合并数据是才会进行聚合</li></ul></li></ul><h3 id="手动合并命令"><a href="#手动合并命令" class="headerlink" title="手动合并命令"></a>手动合并命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 可手动进行合并</span><br>optimize <span class="hljs-keyword">table</span> table_name <span class="hljs-keyword">final</span><br></code></pre></td></tr></table></figure><h2 id="SQL语法"><a href="#SQL语法" class="headerlink" title="SQL语法"></a>SQL语法</h2><ul><li><p>Insert</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 数据插入</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span>(table_name) <span class="hljs-keyword">values</span>(....)(....)<br><br><span class="hljs-comment">-- 表到表的插入</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span>(table_name1) <span class="hljs-keyword">select</span> a,b,c <span class="hljs-keyword">from</span> (table_name2)<br></code></pre></td></tr></table></figure></li><li><p>Update 和 Delete</p><p>Clickhouse提供了Delete和Update的能力，这类查询可看作为Mutation查询，它可以看作Alter的一种。</p><p>虽然可以实现修改和删除，但是和OLTP数据库不同，Mutation语句是一种很‘重’的操作，而且不支持事务</p><p>‘重’的原因是每次修改或者删除会导致放弃目标数据的原有分区，重新建立新的分区，所以尽量做批量的变更，不要进行小数据的操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- delete操作</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> table_name <span class="hljs-keyword">delete</span> <span class="hljs-keyword">where</span> (<span class="hljs-keyword">condition</span>)<br><br><span class="hljs-comment">-- update 操作</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> table_name <span class="hljs-keyword">update</span> <span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">where</span> (<span class="hljs-keyword">condition</span>)<br></code></pre></td></tr></table></figure><p><code>高效进行删除修改操作思路：</code></p><ul><li>主要思路就是更新和是删除操作增加标记字段</li></ul></li><li><p>查询</p><ul><li>Clickhouse查询基本上和SQL差别不大</li><li>支持子查询</li><li>支持CET（Common Table Expression 公用表达式 with 子句）</li><li>支持各种join操作，但是join无法使用缓存，所以即便是两次相同的join语句ck也会视为两条新SQL，<strong>尽量避免使用</strong></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">rollup</span> 上卷<br><span class="hljs-comment">--例如：</span><br><span class="hljs-keyword">rollup</span>(a,b) 相当于一下三种情况的集合<br><span class="hljs-comment">---&gt; 无条件的分组</span><br><span class="hljs-comment">---&gt; group by a</span><br><span class="hljs-comment">---&gt; group by a,b</span><br><br><span class="hljs-keyword">cube</span> 多维分析<br><span class="hljs-comment">--例如：</span><br><span class="hljs-keyword">cube</span>(a,b) 相当于以下几种情况的集合<br><span class="hljs-comment">---&gt; 无条件的分组</span><br><span class="hljs-comment">---&gt; group by a</span><br><span class="hljs-comment">---&gt; group by b</span><br><span class="hljs-comment">---&gt; group by a,b</span><br><br>total 统计<br></code></pre></td></tr></table></figure></li><li><p>alter</p></li><li><p>导出数据</p></li></ul><p><strong>二级索引</strong></p><p><strong>TTL</strong></p><ul><li><p>字段级别</p></li><li><p>表级别</p><p><code>Notes：指定的字段不可以使用主键字段</code></p></li></ul><h2 id="副本"><a href="#副本" class="headerlink" title="副本"></a>副本</h2><h3 id="副本写入流程"><a href="#副本写入流程" class="headerlink" title="副本写入流程"></a>副本写入流程</h3><p><code>clickhouse-a，clickhouse-b互为副本没有主从之分</code></p><img src="/2023/12/22/Clickhouse/1647501880366.png" class="" width="1647501880366"><h3 id="副本启动"><a href="#副本启动" class="headerlink" title="副本启动"></a>副本启动</h3><ol><li><p>启动zookeeper集群</p></li><li><p>在<code>/etc/clickhouse-server/config.d</code>下创建名为<code>metrika.xml</code>，内容如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">yandex</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">zookeeper-servers</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop01<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop02<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">node</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;3&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop03<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>2181<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">node</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">zookeeper-servers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">yandex</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改文件属主：属组</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chown clickhouse:clickhouse metrika.xml<br></code></pre></td></tr></table></figure></li><li><p>在<code>/etc/clickhouse-server/config.xml</code>中添加如下配置，引入外部配置文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">zookeeper</span> <span class="hljs-attr">incl</span>=<span class="hljs-string">&quot;zookeeper-servers&quot;</span> <span class="hljs-attr">optional</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">include_from</span>&gt;</span>/etc/clickhouse-server/config.d/metrika.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include_from</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置完成重启clickhouse即可</p></li><li><p>创建副本表，<code>副本只能同步数据，不能同步表结构，所以我们需要在每台机器上自己手动建表</code></p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sql">hadoop01 :) <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_rep (<br>                 id UInt32,<br>                 sku_id String,<br>                 total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br>                 create_time Datetime<br>                ) engine <span class="hljs-operator">=</span>ReplicatedMergeTree(<span class="hljs-string">&#x27;/clickhouse/table/01/t_order_rep2&#x27;</span>,<span class="hljs-string">&#x27;rep_01&#x27;</span>)<br>                 <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br>                 <span class="hljs-keyword">primary</span> key (id)<br>                 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id);<br> <br>hadoop02 :) <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_rep (<br>                 id UInt32,<br>                 sku_id String,<br>                 total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br>                 create_time Datetime<br>                ) engine <span class="hljs-operator">=</span>ReplicatedMergeTree(<span class="hljs-string">&#x27;/clickhouse/table/01/t_order_rep&#x27;</span>,<span class="hljs-string">&#x27;rep_02&#x27;</span>)<br>                 <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br>                 <span class="hljs-keyword">primary</span> key (id)<br>                 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id);<br> <br>hadoop03 :)  <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_order_rep (<br>                 id UInt32,<br>                 sku_id String,<br>                 total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br>                 create_time Datetime<br>                ) engine <span class="hljs-operator">=</span>ReplicatedMergeTree(<span class="hljs-string">&#x27;/clickhouse/table/01/t_order_rep&#x27;</span>,<span class="hljs-string">&#x27;rep_03&#x27;</span>)<br>                 <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br>                 <span class="hljs-keyword">primary</span> key (id)<br>                 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id);<br>                 <br><br><span class="hljs-comment">-- 在一台节点插入数据，其他节点自动同步</span><br>hadoop01 :)  <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_order_rep <span class="hljs-keyword">values</span><br>(<span class="hljs-number">101</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">102</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">103</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">104</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">105</span>,<span class="hljs-string">&#x27;sku_003&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br><br></code></pre></td></tr></table></figure><h2 id="分片集群"><a href="#分片集群" class="headerlink" title="分片集群"></a>分片集群</h2><p>副本虽然可以提高数据的可用性，降低丢失风险，但是每台服务器实际上必须容纳全量数据，对数据的<code>横向扩展</code>没有解决</p><p>要解决数据水平切分问题，需要引入分片的概念。通过分片把一份完整的数据进行切分，不同的分片分布到不同的节点上，再通过Distributed表引擎把数据拼接起来一同使用</p><p><strong>Distributed表引擎本身不存储数据，数据存储在节点本地存储系统中</strong>，有点类似MyCat之于MySql，成为一种中间件，通过分布式逻辑表来写入、分发、路由来操作多台节点不同分片的分布式数据</p><p><code>Notes：Clickhouse的集群是表级别的，实际企业中，大部分做了高可用，但是没有用分片，避免降低查询性能以及集群操作的复杂性</code></p><h3 id="集群写入流程"><a href="#集群写入流程" class="headerlink" title="集群写入流程"></a>集群写入流程</h3><img src="/2023/12/22/Clickhouse/1648779049635.png" class="" width="1648779049635"><h3 id="集群读取流程"><a href="#集群读取流程" class="headerlink" title="集群读取流程"></a>集群读取流程</h3><img src="/2023/12/22/Clickhouse/1648779096352.png" class="" width="1648779096352"><p><strong>三分片两副本配置（可以配置六台节点也可以配置三台节点仅供参考）</strong></p><ul><li><p>在<code>/etc/clickhouse-server/config.d</code>下配置在<code>metrika.xml</code>中，内容如下</p><ul><li><p><strong>三节点配置，最好是一个分片副本一台节点，如果资源不够可以使用三台节点进行配置</strong></p><p><a href="https://www.cnblogs.com/linlf03/p/15392198.html">3分片2副本3节点，涉及到单节点双实例配置</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">yandex</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">remote_servers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--集群名称--&gt;</span> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">clickhouse_cluster</span>&gt;</span> <br>            <span class="hljs-comment">&lt;!--集群的第一个分片--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                <span class="hljs-comment">&lt;!--副本之间内部同步打开--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--该分片的第一个副本--&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop101<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--该分片的第二个副本--&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop102<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--集群的第二个分片--&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                 <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop102<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9001<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--集群的第三个分片--&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                 <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9001<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop101<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9001<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">clickhouse_cluster</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">remote_servers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">yandex</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>六节点配置</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">yandex</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">remote_servers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--集群名称--&gt;</span> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">clickhouse_cluster</span>&gt;</span> <br>            <span class="hljs-comment">&lt;!--集群的第一个分片--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                <span class="hljs-comment">&lt;!--副本之间内部同步打开--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--该分片的第一个副本--&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop101<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--该分片的第二个副本--&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop102<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--集群的第二个分片--&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                 <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop104<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--集群的第三个分片--&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">shard</span>&gt;</span> <br>                 <span class="hljs-tag">&lt;<span class="hljs-name">internal_replication</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">internal_replication</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop105<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">replica</span>&gt;</span> <br>                     <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span>hadoop106<span class="hljs-tag">&lt;/<span class="hljs-name">host</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9000<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">replica</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">shard</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">clickhouse_cluster</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">remote_servers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">yandex</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="分片集群创建分布式表"><a href="#分片集群创建分布式表" class="headerlink" title="分片集群创建分布式表"></a>分片集群创建分布式表</h3><ul><li><p>创建本地表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> st_order_rmt666 <span class="hljs-keyword">on</span> cluster clickhouse_cluster (<br> id UInt32,<br> sku_id String,<br> total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br> create_time Datetime<br>) engine <br><span class="hljs-operator">=</span>ReplicatedMergeTree(<span class="hljs-string">&#x27;/clickhouse/tables/&#123;shard&#125;/st_order_rmt666&#x27;</span>,<span class="hljs-string">&#x27;&#123;replica&#125;&#x27;</span>)<br> <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(create_time)<br> <span class="hljs-keyword">primary</span> key (id)<br> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> (id,sku_id);<br></code></pre></td></tr></table></figure></li><li><p>创建分布式表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> st_order_rmt666_all <span class="hljs-keyword">on</span> cluster clickhouse_cluster<br>(<br> id UInt32,<br> sku_id String,<br> total_amount <span class="hljs-type">Decimal</span>(<span class="hljs-number">16</span>,<span class="hljs-number">2</span>),<br> create_time Datetime<br>)engine <span class="hljs-operator">=</span> Distributed(clickhouse_cluster,<span class="hljs-keyword">default</span>, st_order_rmt666,hiveHash(sku_id));<br><br><span class="hljs-comment">-- Distributed（集群名称，库名，本地表名，分片键）</span><br><span class="hljs-comment">-- 分片键必须是整型数字，所以用 hiveHash 函数转换</span><br></code></pre></td></tr></table></figure></li><li><p>插入测试数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> st_order_rmt666_all <span class="hljs-keyword">values</span><br>(<span class="hljs-number">201</span>,<span class="hljs-string">&#x27;sku_001&#x27;</span>,<span class="hljs-number">1000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>) ,<br>(<span class="hljs-number">202</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">203</span>,<span class="hljs-string">&#x27;sku_004&#x27;</span>,<span class="hljs-number">2500.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">204</span>,<span class="hljs-string">&#x27;sku_002&#x27;</span>,<span class="hljs-number">2000.00</span>,<span class="hljs-string">&#x27;2020-06-01 12:00:00&#x27;</span>),<br>(<span class="hljs-number">205</span>,<span class="hljs-string">&#x27;sku_003&#x27;</span>,<span class="hljs-number">600.00</span>,<span class="hljs-string">&#x27;2020-06-02 12:00:00&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>查看数据</p><img src="/2023/12/22/Clickhouse/1648799917430.png" class="" width="1648799917430"><img src="/2023/12/22/Clickhouse/1648800591071.png" class="" width="1648800591071"></li></ul><h1 id="Clickhouse高级"><a href="#Clickhouse高级" class="headerlink" title="Clickhouse高级"></a>Clickhouse高级</h1><h2 id="Explain查看执行计划"><a href="#Explain查看执行计划" class="headerlink" title="Explain查看执行计划"></a>Explain查看执行计划</h2><p>在 clickhouse 20.6 版本之前要查看 SQL 语句的执行计划需要设置日志级别为 trace 才能可以看到，并且只能真正执行 sql，在执行日志里面查看。在 20.6 版本引入了原生的执行计划的语法。在 <strong>20.6.3 版本</strong>成为正式版本的功能。 </p><ol><li><p>基本语法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">EXPLAIN [AST <span class="hljs-operator">|</span> SYNTAX <span class="hljs-operator">|</span> PLAN <span class="hljs-operator">|</span> PIPELINE] [setting <span class="hljs-operator">=</span> <span class="hljs-keyword">value</span>, ...] <br><span class="hljs-keyword">SELECT</span> ... [FORMAT ...]<br></code></pre></td></tr></table></figure><ul><li>PLAN：用于查看执行计划，默认值</li></ul></li></ol><ul><li>header 打印计划中各个步骤的 head 说明，默认关闭，默认值 0;<ul><li>description 打印计划中各个步骤的描述，默认开启，默认值 1； </li><li>actions 打印计划中各个步骤的详细信息，默认关闭，默认值 0</li></ul></li><li>AST ：用于查看语法树</li><li>SYNTAX：用于优化语法; </li><li>PIPELINE：用于查看 PIPELINE 计划。 <ul><li>header 打印计划中各个步骤的 head 说明，默认关闭; </li><li>graph 用 DOT 图形语言描述管道图，默认关闭，需要查看相关的图形需要配合 graphviz 查看； </li><li>actions 如果开启了 graph，紧凑打印打，默认开启。</li></ul></li></ul><p>   <code>Notes：</code>PLAN和PIPELINE还可以进行额外的显示设置，如上参数所示</p><h2 id="建表优化"><a href="#建表优化" class="headerlink" title="建表优化"></a>建表优化</h2><h3 id="数据类型优化"><a href="#数据类型优化" class="headerlink" title="数据类型优化"></a>数据类型优化</h3><h4 id="时间类型"><a href="#时间类型" class="headerlink" title="时间类型"></a>时间类型</h4><p>建表时能用数值型或日期时间型表示的字段就不要用字符串，全 String 类型在以 Hive 为中心的数仓建设中常见，但 ClickHouse 环境不应受此影响。 </p><p>虽然 ClickHouse 底层将 DateTime 存储为时间戳 Long 类型，但不建议存储 Long 类型，因为 <code>DateTime 不需要经过函数转换处理，执行效率高、可读性好</code>。 </p><h4 id="空值存储"><a href="#空值存储" class="headerlink" title="空值存储"></a>空值存储</h4><p>官方已经指出 <strong>Nullable</strong> <strong>类型几乎总是会拖累性能</strong>，因为<code>存储 Nullable 列时需要创建一个</code> </p><p><code>额外的文件来存储 NULL 的标记，并且 Nullable 列无法被索引</code>。因此除非极特殊情况，应直 </p><p>接使用字段默认值表示空，或者自行指定一个在业务中无意义的值</p><h3 id="分区和索引"><a href="#分区和索引" class="headerlink" title="分区和索引"></a>分区和索引</h3><p>分区粒度根据业务特点决定，不宜过粗或过细。一般选择<strong>按天分区</strong>，也可以指定为 Tuple()，以单表一亿数据为例，分区大小控制在 10-30 个为最佳。</p><p>必须指定索引列，ClickHouse 中的索引列即排序列，通过 order by 指定，一般在查询条件中经常被用来充当筛选条件的属性被纳入进来；可以是单一维度，也可以是组合维度的索引；通常需要满足高级列在前、查询频率大的在前原则；还有基数特别大的不适合做索引列， 如用户表的 userid 字段；通常<strong>筛选后的数据满足在百万以内为最佳</strong>。</p><h3 id="表参数"><a href="#表参数" class="headerlink" title="表参数"></a>表参数</h3><p><code>Index_granularity 是用来控制索引粒度的，默认是 8192，如非必须不建议调整。</code> </p><p>如果表中不是必须保留全量历史数据，建议<code>指定 TTL</code>（生存时间值），可以免去手动过期历史数据的麻烦，TTL 也可以通过 alter table 语句随时修改</p><h3 id="写入和删除优化"><a href="#写入和删除优化" class="headerlink" title="写入和删除优化"></a>写入和删除优化</h3><ol><li><p>尽量不要执行单条或小批量删除和插入操作，这样会产生小分区文件，给后台Merge任务带来巨大压力</p></li><li><p>不要一次性写入太多分区，或写入数据太快，数据写入太快会导致Merge速度跟不上而报错，一般建议每秒发起2-3次写入操作，每次操作写入2w~5w条数据（根据服务器性能而定）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">写入过快报错信息：</span><br>1. Code: 252, e.displayText() = DB::Exception: Too many parts(304). <br>Merges are processing significantly slower than inserts<br>2. Code: 241, e.displayText() = DB::Exception: Memory limit (for query) <br>exceeded:would use 9.37 GiB (attempt to allocate chunk of 301989888 <br>bytes), maximum: 9.31 GiB<br></code></pre></td></tr></table></figure><p>处理方式： </p><p>“ Too many parts 处理 ” ：使用 WAL 预写日志，提高写入性能。 <code>in_memory_parts_enable_wal</code> 默认为 true 。</p><p>在服务器内存充裕的情况下增加内存配额，一般通过 <code>max_memory_usage</code> 来实现</p><p>在服务器内存不充裕的情况下，建议将超出部分内容分配到系统硬盘上，但会降低执行速度，一般通过<code>max_bytes_before_external_group_by、max_bytes_before_external_sort</code> 参数来实现。</p></li></ol><h3 id="常见配置"><a href="#常见配置" class="headerlink" title="常见配置"></a>常见配置</h3><p><a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/">config.xm配置项</a></p><p><a href="https://clickhouse.com/docs/en/operations/settings/">user.xml配置项</a></p><h4 id="CPU资源"><a href="#CPU资源" class="headerlink" title="CPU资源"></a>CPU资源</h4><table><thead><tr><th>配置</th><th>描述</th></tr></thead><tbody><tr><td>background_pool_size</td><td>后台线程池的大小，merge 线程就是在该线程池中执行，该线程池 不仅仅是给 merge 线程用的，默认值 16，允许的前提下建议改成 <strong>cpu 个数的 2 倍（线程数）</strong>。</td></tr><tr><td>background_schedule_pool_size</td><td>执行后台任务（复制表、Kafka 流、DNS 缓存更新）的线程数。默认 128，建议改成 <strong>cpu 个数的 2 倍</strong>（线程数）。</td></tr><tr><td>background_distributed_schedule_ pool_size</td><td>设置为分布式发送执行后台任务的线程数，默认 16，建议改成 <strong>cpu个数的 2 倍（线程数）</strong>。</td></tr><tr><td>max_concurrent_queries</td><td>最大并发处理的请求数(包含 select,insert 等)，默认值 100，推荐 150(不够再加)~300</td></tr><tr><td>max_threads</td><td>设置单个查询所能使用的最大 cpu 个数，默认是 cpu 核数</td></tr></tbody></table><h4 id="内存资源"><a href="#内存资源" class="headerlink" title="内存资源"></a>内存资源</h4><table><thead><tr><th>配置</th><th>描述</th></tr></thead><tbody><tr><td>max_memory_usage</td><td>此参数在 users.xml 中,表示单次 Query 占用内存最大值，该值可以设置的比较大，这样可以提升集群查询的上限。保留一点给 OS，比如 <strong>128G 内存的机器，设置为 100GB。</strong></td></tr><tr><td>max_bytes_before_external_group_by</td><td>一般按照 max_memory_usage 的一半设置内存，当 group 使用内存超过阈值后会刷新到磁盘进行。<br>因为 clickhouse 聚合分两个阶段：查询并及建立中间数据、合并中间数据，<strong>结合上一项，建议 50GB。</strong></td></tr><tr><td>max_bytes_before_external_sort</td><td>当 order by 已使用 max_bytes_before_external_sort 内存就进行溢写磁盘(基于磁盘排序)，如果不设置该值，那么当内存不够时直接抛错，设置了该值 order by 可以正常完成，但是速度相对存内存来说肯定要慢点(实测慢的非常多，无法接受)。</td></tr><tr><td>max_table_size_to_drop</td><td>此参数在 config.xml 中，应用于需要删除表或分区的情况，默认是50GB，意思是如果删除 50GB 以上的分区表会失败。<strong>建议修改为 0</strong>，这样不管多大的分区表都可以删除。</td></tr></tbody></table><h4 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h4><p>ClickHouse 不支持设置多数据目录，为了提升数据 io 性能，可以挂载虚拟券组，一个券组绑定多块物理磁盘提升读写性能，多数据查询场景 SSD 会比普通机械硬盘快 2-3 倍</p><h2 id="ClickHouse语法优化"><a href="#ClickHouse语法优化" class="headerlink" title="ClickHouse语法优化"></a>ClickHouse语法优化</h2><p>ClickHouse 的 SQL 优化规则是基于 RBO(Rule Based Optimization)，下面是一些优化规则</p><h3 id="Count优化"><a href="#Count优化" class="headerlink" title="Count优化"></a>Count优化</h3><p>在查询表中数据总量时，使用count()或者count(*)，且没有where语句，则直接查询system.tables 的 total_rows（总数是有记录，可以直接查询，不需要针对数据进行读取后统计）</p><p>如果查询中使用count(column_name)，则将会读取数据进行统计没有做优化</p><h3 id="消除子查询重复列"><a href="#消除子查询重复列" class="headerlink" title="消除子查询重复列"></a>消除子查询重复列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- sql_1</span><br><span class="hljs-comment">-- 子查询中出现重复列</span><br><span class="hljs-keyword">select</span> a.trip_id <span class="hljs-keyword">AS</span> a_trip,<br> b.trip_id <span class="hljs-keyword">AS</span> b_trip,<br> b.vendor_id<br><span class="hljs-keyword">FROM</span><br>trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (<br><span class="hljs-keyword">SELECT</span><br>trip_id,<br>vendor_id, <br>vendor_id<span class="hljs-comment">-- 子查询中出现重复列</span><br><span class="hljs-keyword">FROM</span><br>trips<br>) 　<span class="hljs-keyword">AS</span> b <span class="hljs-keyword">USING</span> (trip_id)<br>LIMIT <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">-- 进行语法优化</span><br>EXPLAIN syntax <span class="hljs-keyword">SELECT</span><br>a.trip_id <span class="hljs-keyword">AS</span> a_trip,<br>b.trip_id <span class="hljs-keyword">AS</span> b_trip,<br>b.vendor_id<br><span class="hljs-keyword">FROM</span><br>trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (<br><span class="hljs-keyword">SELECT</span><br>trip_id,<br>vendor_id,<br>vendor_id<br><span class="hljs-keyword">FROM</span><br>trips<br>) 　<span class="hljs-keyword">AS</span> b <span class="hljs-keyword">USING</span> (trip_id)<br>LIMIT <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">-- sql_2</span><br><span class="hljs-comment">-- 进行优化的结果，将子查询中重复列自动优化保留一列</span><br><span class="hljs-keyword">SELECT</span><br>a.trip_id <span class="hljs-keyword">AS</span> a_trip,<br>b.trip_id <span class="hljs-keyword">AS</span> b_trip,<br>b.vendor_id<br><span class="hljs-keyword">FROM</span><br>trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (<br><span class="hljs-keyword">SELECT</span><br>trip_id,<br>vendor_id<br><span class="hljs-keyword">FROM</span><br>trips<br>) 　<span class="hljs-keyword">AS</span> b <span class="hljs-keyword">USING</span> (trip_id)<br>LIMIT <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p><code>Notes：</code>即便是查询时使用了sql_1，clickhouse也会自动优化为sql_2，在进行查询</p><h3 id="谓词下推"><a href="#谓词下推" class="headerlink" title="谓词下推"></a>谓词下推</h3><p> 将过滤条件表达式（&#x3D;、！&#x3D;、like、in、between、&gt;、&lt;…）尽量靠近要过滤的数据源，达到尽早过滤无用数据的目的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<span class="hljs-keyword">SELECT</span> trip_id <span class="hljs-keyword">FROM</span> trips)<br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<span class="hljs-keyword">SELECT</span> vendor_id <span class="hljs-keyword">FROM</span> trips)<br>)<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span>;<br><br><span class="hljs-comment">-- 进行优化的sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<br><span class="hljs-keyword">SELECT</span><br>trip_id<br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span><br>)<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span><br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>(<br><span class="hljs-keyword">SELECT</span><br>vendor_id<br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span><br>)<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span><br>)<br><span class="hljs-keyword">WHERE</span><br>trip_id <span class="hljs-operator">=</span> <span class="hljs-number">1201746944</span>;<br></code></pre></td></tr></table></figure><h3 id="聚合计算外推"><a href="#聚合计算外推" class="headerlink" title="聚合计算外推"></a>聚合计算外推</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 原始sql</span><br>syntax <span class="hljs-keyword">SELECT</span><br><span class="hljs-built_in">sum</span>(trip_id <span class="hljs-operator">*</span> <span class="hljs-number">2</span>)<br><span class="hljs-keyword">FROM</span><br>trips;<br><br><span class="hljs-comment">-- 优化sql</span><br>syntax <span class="hljs-keyword">SELECT</span><br><span class="hljs-built_in">sum</span>(trip_id) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">FROM</span><br>trips;<br></code></pre></td></tr></table></figure><h3 id="聚合消除"><a href="#聚合消除" class="headerlink" title="聚合消除"></a>聚合消除</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-built_in">max</span>(trip_id)<br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>trip_id;<br><br><span class="hljs-comment">-- 优化sql</span><br><span class="hljs-keyword">SELECT</span><br>trip_id<span class="hljs-comment">-- 无意义的计算会进行消除</span><br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>trip_id;<br><br><span class="hljs-comment">-- 原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-built_in">sum</span>(trip_id)<br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>trip_id;<br><br><span class="hljs-comment">-- 优化sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-built_in">sum</span>(trip_id) <span class="hljs-comment">-- 求和函数不会消除</span><br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>trip_id;<br></code></pre></td></tr></table></figure><h3 id="删除重复-Order-by-key"><a href="#删除重复-Order-by-key" class="headerlink" title="删除重复 Order by key"></a>删除重复 Order by key</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--  原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>trip_id,<br>trip_id;<br><br><span class="hljs-comment">-- 优化sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>trip_id<br></code></pre></td></tr></table></figure><h3 id="删除重复-Limit-by-key"><a href="#删除重复-Limit-by-key" class="headerlink" title="删除重复 Limit by key"></a>删除重复 Limit by key</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--  原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips<br>Limit <span class="hljs-number">3</span> <span class="hljs-keyword">BY</span><br>trip_id,<br>trip_id;<br><br><span class="hljs-comment">--  优化sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips<br>Limit <span class="hljs-number">3</span> <span class="hljs-keyword">BY</span><br>trip_id;<br></code></pre></td></tr></table></figure><h3 id="删除重复Using-key"><a href="#删除重复Using-key" class="headerlink" title="删除重复Using key"></a>删除重复Using key</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--  原始sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> trips <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">Using</span>(trip_id,trip_id);<br><br><span class="hljs-comment">--  优化sql</span><br><span class="hljs-keyword">SELECT</span><br><span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span><br>trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> trips <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">Using</span>(trip_id);<br></code></pre></td></tr></table></figure><h3 id="标量替换"><a href="#标量替换" class="headerlink" title="标量替换"></a>标量替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 原始sql</span><br><span class="hljs-keyword">WITH</span> (<br>        <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">sum</span>(bytes)<br>        <span class="hljs-keyword">FROM</span> system.parts<br>        <span class="hljs-keyword">WHERE</span> active<br>    ) <span class="hljs-keyword">AS</span> total_disk_usage<br><span class="hljs-keyword">SELECT</span><br>    (<span class="hljs-built_in">sum</span>(bytes) <span class="hljs-operator">/</span> total_disk_usage) <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span> table_disk_usage,<br>    <span class="hljs-keyword">table</span><br><span class="hljs-keyword">FROM</span> system.parts<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">table</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> table_disk_usage <span class="hljs-keyword">DESC</span><br>LIMIT <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">-- 优化Sql</span><br>┌─explain──────────────────────────────────────────<br>│ <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">identity</span>(<span class="hljs-built_in">CAST</span>(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;UInt64&#x27;</span>)) <span class="hljs-keyword">AS</span> total_disk_usage                            │<br>│ <span class="hljs-keyword">SELECT</span>                                                                          │<br>│     (<span class="hljs-built_in">sum</span>(bytes_on_disk <span class="hljs-keyword">AS</span> bytes) <span class="hljs-operator">/</span> total_disk_usage) <span class="hljs-operator">*</span> <span class="hljs-number">100</span> <span class="hljs-keyword">AS</span> table_disk_usage, │<br>│     <span class="hljs-keyword">table</span>                                                                       │<br>│ <span class="hljs-keyword">FROM</span> system.parts                                                               │<br>│ <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">table</span>                                                                  │<br>│ <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> table_disk_usage <span class="hljs-keyword">DESC</span>                                                  │<br>│ LIMIT <span class="hljs-number">10</span>                                                                        │<br>└───────────────────────────────────────────────<br></code></pre></td></tr></table></figure><h3 id="三元运算符优化"><a href="#三元运算符优化" class="headerlink" title="三元运算符优化"></a>三元运算符优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 开启优化策略，如果没有权限的话可以在查询语句中设置，表示针对本次查询生效</span><br><span class="hljs-keyword">set</span> optimize_if_chain_to_multiif <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">-- 原始sql</span><br>EXPLAIN SYNTAX <br><span class="hljs-keyword">SELECT</span> number <span class="hljs-operator">=</span> <span class="hljs-number">1</span> ? <span class="hljs-string">&#x27;hello&#x27;</span> : (number <span class="hljs-operator">=</span> <span class="hljs-number">2</span> ? <span class="hljs-string">&#x27;world&#x27;</span> : <span class="hljs-string">&#x27;atguigu&#x27;</span>) <br><span class="hljs-keyword">FROM</span> numbers(<span class="hljs-number">10</span>) <br>SETTINGS optimize_if_chain_to_multiif <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">-- 优化sql</span><br>┌─explain───────────────────────────────────<br>│ <span class="hljs-keyword">SELECT</span> multiIf(number <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;hello&#x27;</span>, number <span class="hljs-operator">=</span> <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;world&#x27;</span>, <span class="hljs-string">&#x27;atguigu&#x27;</span>) │<br>│ <span class="hljs-keyword">FROM</span> numbers(<span class="hljs-number">10</span>)                                                    │<br>│ SETTINGS optimize_if_chain_to_multiif <span class="hljs-operator">=</span> <span class="hljs-number">1</span>                           │<br>└────────────────────────────────────────<br></code></pre></td></tr></table></figure><h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><h3 id="单表查询"><a href="#单表查询" class="headerlink" title="单表查询"></a>单表查询</h3><h4 id="Prewhere代替where"><a href="#Prewhere代替where" class="headerlink" title="Prewhere代替where"></a>Prewhere代替where</h4><p>Prewhere 和 where 语句的作用相同，用来过滤数据。不同之处在于 prewhere 只支持 <em>MergeTree 族系列引擎的表，*<em>首先会读取指定的列数据，来判断数据过滤，等待数据过滤 之后再读取 select 声明的列字段来补全其余属性。</em></em></p><p>当查询列明显多于筛选列时使用 Prewhere 可十倍提升查询性能，Prewhere 会自动优化执行过滤阶段的数据读取方式，降低 io 操作。</p><p>默认情况，我们肯定不会关闭 where 自动优化成 prewhere，但是某些场景即使开启优化，也不会自动转换成 prewhere，需要手动指定 prewhere： </p><ul><li>使用常量表达式</li><li>使用默认值为 alias 类型的字段 </li><li>包含了 arrayJOIN，globalIn，globalNotIn 或者 indexHint 的查询</li><li>select 查询的列字段和 where 的谓词相同</li><li>使用了主键字段</li></ul><p><code>Notes：基本上在使用查询时就是用Prewhere就好</code></p><h4 id="数据采样"><a href="#数据采样" class="headerlink" title="数据采样"></a>数据采样</h4><p>通过采样运算可极大提升数据分析的性能</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> Title,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> PageViews <br><span class="hljs-keyword">FROM</span> hits_v1<br>SAMPLE <span class="hljs-number">0.1</span> <span class="hljs-comment">-- 代表采样 10%的数据,也可以是具体的条数</span><br><span class="hljs-keyword">WHERE</span> CounterID <span class="hljs-operator">=</span><span class="hljs-number">57</span><br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Title<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> PageViews <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">1000</span><br></code></pre></td></tr></table></figure><h4 id="列裁剪和分区裁剪"><a href="#列裁剪和分区裁剪" class="headerlink" title="列裁剪和分区裁剪"></a>列裁剪和分区裁剪</h4><p>数据量太大时应避免使用 **select *** 操作，查询的性能会与查询的字段大小和数量成线性关系，字段越少，消耗的 io 资源越少，性能就会越高。</p><p>列裁剪：查询时写出确定查询字段，不要使用 ***** 进行查询</p><p>分区裁剪：查询时使用某个分区数据</p><h4 id="Order-by-结合-where-limit使用"><a href="#Order-by-结合-where-limit使用" class="headerlink" title="Order by 结合 where limit使用"></a>Order by 结合 where limit使用</h4><p>单独使用Order by会进行全局排序，所以建议在使用的时候加上 where&#x2F;limit 进行使用</p><h4 id="避免构建虚拟列"><a href="#避免构建虚拟列" class="headerlink" title="避免构建虚拟列"></a>避免构建虚拟列</h4><p>如非必须，不要在结果集上构建虚拟列（原数据集不存在的列），虚拟列非常消耗资源浪费性能，可以考虑在前端进行处理，或者在表中构造实际字段进行额外存储。</p><h4 id="uniqCombined替代distinct"><a href="#uniqCombined替代distinct" class="headerlink" title="uniqCombined替代distinct"></a>uniqCombined替代distinct</h4><p>性能可提升 10 倍以上，uniqCombined 底层采用类似 HyperLogLog 算法实现，能接收 2%左右的数据误差，可直接使用这种去重方式提升查询性能。Count(distinct )会使用 uniqExact 精确去重。</p><p>不建议在千万级不同数据上执行 distinct 去重查询，改为近似去重 uniqCombined。</p><h4 id="使用物化视图"><a href="#使用物化视图" class="headerlink" title="使用物化视图"></a>使用物化视图</h4><p>mysql中的视图仅仅存储的时查询的逻辑，并没有将数据保存下来</p><p>ck中的视图会将查询逻辑以及数据全部保存下来，称之为<strong>物化视图</strong></p><h4 id="其他注意事项"><a href="#其他注意事项" class="headerlink" title="其他注意事项"></a>其他注意事项</h4><ul><li><p>查询熔断</p><blockquote><p> 为了避免因个别慢查询引起的服务雪崩的问题，除了可以为单个查询设置超时以外，还可以配置周期熔断，在一个查询周期内，如果用户频繁进行慢查询操作超出规定阈值后将无法继续进行查询操作。</p></blockquote></li><li><p>关闭虚拟内存</p><blockquote><p>物理内存和虚拟内存的数据交换，会导致查询变慢，<strong>资源允许的情况下</strong>关闭虚拟内存。</p></blockquote></li><li><p>配置join_use_nulls</p><blockquote><p>为每一个账户添加 join_use_nulls 配置，左表中的一条记录在右表中不存在，右表的相应字段会返回该字段相应数据类型的默认值，而不是标准 SQL 中的 Null 值。</p></blockquote></li><li><p>批量插入时先排序</p><blockquote><p>批量写入数据时，必须控制每个批次的数据中涉及到的分区的数量，在写入之前最好对需要导入的数据进行排序。无序的数据或者涉及的分区太多，会导致 ClickHouse 无法及时对新导入的数据进行合并，从而影响查询性能。 </p></blockquote></li><li><p>关注CUP</p><blockquote><p>cpu 一般在 50%左右会出现查询波动，达到 70%会出现大范围的查询超时，cpu 是最关键的指标，要非常关注。</p></blockquote></li></ul><h3 id="多表关联"><a href="#多表关联" class="headerlink" title="多表关联"></a>多表关联</h3><ul><li><p>准备数据以及表结构</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建一张小表</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_v2 <br>ENGINE <span class="hljs-operator">=</span> MergeTree<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(pickup_date)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pickup_datetime<br><span class="hljs-comment">-- 根据trip_id字段进行抽样</span><br>SAMPLE <span class="hljs-keyword">BY</span> intHash32(trip_id)<br>SETTINGS index_granularity <span class="hljs-operator">=</span> <span class="hljs-number">8192</span><br><span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> trips limit <span class="hljs-number">10000</span>;<br><br><span class="hljs-comment">-- 创建空表，防止控制台疯狂打印</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_v3<br>ENGINE <span class="hljs-operator">=</span> MergeTree<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(pickup_date)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pickup_datetime<br>SAMPLE <span class="hljs-keyword">BY</span> intHash32(trip_id)<br>SETTINGS index_granularity <span class="hljs-operator">=</span> <span class="hljs-number">8192</span><br><span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> trips <span class="hljs-keyword">where</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure></li><li><p>表中数据</p><table><thead><tr><th>表名</th><th>数据量</th></tr></thead><tbody><tr><td>trips</td><td>1999657</td></tr><tr><td>trips_v2</td><td>10000</td></tr><tr><td>trips_v3</td><td>0</td></tr></tbody></table></li></ul><h4 id="用IN代替JOIN"><a href="#用IN代替JOIN" class="headerlink" title="用IN代替JOIN"></a>用IN代替JOIN</h4><p><strong>JOIN操作</strong>是将右表中的所有数据加载到内存中，然后左表中的数据一条一条查询内存中数据，所以最好尽量避免使用JOIN操作</p><p>当多表联查时，查询的数据仅从其中一张表出时，可考虑用 IN 操作而不是 JOIN </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 使用in操作</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_v3 <span class="hljs-keyword">SELECT</span> a.<span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">WHERE</span> a.trip_id <span class="hljs-keyword">IN</span> (<br>    <span class="hljs-keyword">SELECT</span> trip_id<br>    <span class="hljs-keyword">FROM</span> trips_v2<br>)<br><br><span class="hljs-comment">-- 耗时0.045 sec</span><br><span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.045</span> sec. Processed <span class="hljs-number">2.01</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">10.99</span> MB (<span class="hljs-number">44.45</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">243.13</span> MB<span class="hljs-operator">/</span>s.)<br><br><br><span class="hljs-comment">-- 使用join操作</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_v3 <span class="hljs-keyword">SELECT</span> a.<span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> trips_v2 <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ON</span> a.trip_id <span class="hljs-operator">=</span> b.trip_id<br><br><span class="hljs-comment">-- 耗时6.258 sec</span><br><span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">6.258</span> sec. Processed <span class="hljs-number">2.01</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">597.59</span> MB (<span class="hljs-number">321.13</span> thousand <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">95.49</span> MB<span class="hljs-operator">/</span>s.)<br><br></code></pre></td></tr></table></figure><h4 id="大小表Join"><a href="#大小表Join" class="headerlink" title="大小表Join"></a>大小表Join</h4><p>多表 join 时要满足<code>小表在右</code>的原则，右表关联时被加载到内存中与左表进行比较，ClickHouse 中无论是 Left join 、Right join 还是 Inner join 永远都是拿着右表中的每一条记录到左表中查找该记录是否存在，所以右表必须是小表。 </p><p><code>数据量太小并没有测试出来想要的结果</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 小表在右</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_v3 <span class="hljs-keyword">SELECT</span> a.<span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> trips <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> trips_v2 <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ON</span> a.trip_id <span class="hljs-operator">=</span> b.trip_id<br><br><span class="hljs-comment">-- 耗时6.258 sec</span><br><span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">6.258</span> sec. Processed <span class="hljs-number">2.01</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">597.59</span> MB (<span class="hljs-number">321.13</span> thousand <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">95.49</span> MB<span class="hljs-operator">/</span>s.)<br><br><span class="hljs-comment">-- 大表在右</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_v3 <span class="hljs-keyword">SELECT</span> a.<span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> trips_v2 <span class="hljs-keyword">AS</span> a<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> trips <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ON</span> a.trip_id <span class="hljs-operator">=</span> b.trip_id<br><br><span class="hljs-comment">-- 耗时0.199 sec</span><br><span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.199</span> sec. Processed <span class="hljs-number">2.01</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">10.99</span> MB (<span class="hljs-number">10.10</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">55.23</span> MB<span class="hljs-operator">/</span>s.)<br></code></pre></td></tr></table></figure><h4 id="分布式表要使用GLOBAL"><a href="#分布式表要使用GLOBAL" class="headerlink" title="分布式表要使用GLOBAL"></a>分布式表要使用GLOBAL</h4><p><code>两张分布式表</code>上的 IN 和 JOIN 之前必须加上 <code>GLOBAL 关键字</code>，右表只会在接收查询请求的那个节点查询一次，并将其分发到其他节点上。如果不加 GLOBAL 关键字的话，每个节点都会单独发起一次对右表的查询，而右表又是分布式表，就导致右表一共会被查询 N²次（N是该分布式表的分片数量），这就是<code>查询放大</code>，会带来很大开销。</p><h4 id="使用字典表"><a href="#使用字典表" class="headerlink" title="使用字典表"></a>使用字典表</h4><p>将一些需要关联分析的业务创建成字典表进行 join 操作，前提是字典表不宜太大，因为<code>字典表会常驻内存</code></p><h4 id="提前过滤数据"><a href="#提前过滤数据" class="headerlink" title="提前过滤数据"></a>提前过滤数据</h4><p>通过增加逻辑过滤可以减少数据扫描，达到提高执行速度及降低内存消耗的目的</p><h2 id="数据一致性（重点）"><a href="#数据一致性（重点）" class="headerlink" title="数据一致性（重点）"></a>数据一致性（重点）</h2><p>查询 CK 手册发现，即便对数据一致性支持最好的 Mergetree，也只是保证<strong>最终一致性</strong></p><p><code>ReplacingMergeTree</code>引擎和<strong>MergeTree</strong>的区别在于它会删除相同排序键值的重复项</p><p>数据的去重只会在数据合并期间，合并会在后台一个不确定的时间进行，因此你无法预先做出计划，有些数据可能仍然未被处理。尽管你可以调用<strong>OPTIMIZE</strong>语句发起计划之外的合并，但请不要依靠它，因为<strong>OPTIMIZE语句会引发对数据的大量读写</strong></p><p>因此<strong>ReplacingMergeTree</strong>适用于在后台清楚重复数据以节省空间，但是它不保证没有重复数据的出现。</p><p>我们在使用ReplacingMergeTree、SummingMergeTree这类表引擎的时候，会出现短暂的数据不一致的情况。</p><p>在某些对数据一致性非常敏感的场景中，通常有以下几种解决方案</p><h3 id="准备测试数据"><a href="#准备测试数据" class="headerlink" title="准备测试数据"></a>准备测试数据</h3><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> test_a(<br> user_id UInt64,<br> score String,<br> deleted UInt8 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br> create_time DateTime <span class="hljs-keyword">DEFAULT</span> toDateTime(<span class="hljs-number">0</span>)<br>)ENGINE<span class="hljs-operator">=</span> ReplacingMergeTree(create_time)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> user_id;<br></code></pre></td></tr></table></figure><ul><li>user_id 是数据去重更新的标识; </li><li>create_time 是版本号字段，每组数据中 create_time 最大的一行表示最新的数据;</li><li>deleted 是自定的一个标记位，比如 0 代表未删除，1 代表删除数据。</li></ul><h4 id="写入1000w数据"><a href="#写入1000w数据" class="headerlink" title="写入1000w数据"></a>写入1000w数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> test_a(user_id,score)<br><span class="hljs-keyword">WITH</span>(<br> <span class="hljs-keyword">SELECT</span> [<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;G&#x27;</span>]<br>)<span class="hljs-keyword">AS</span> dict<br><span class="hljs-keyword">SELECT</span> number <span class="hljs-keyword">AS</span> user_id, dict[number<span class="hljs-operator">%</span><span class="hljs-number">7</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>] <span class="hljs-keyword">FROM</span> numbers(<span class="hljs-number">10000000</span>);<br></code></pre></td></tr></table></figure><h4 id="修改前50w行数据，修改内容包括name和create-time字段"><a href="#修改前50w行数据，修改内容包括name和create-time字段" class="headerlink" title="修改前50w行数据，修改内容包括name和create_time字段"></a>修改前50w行数据，修改内容包括name和create_time字段</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> test_a(user_id,score,create_time)<br><span class="hljs-keyword">WITH</span>(<br> <span class="hljs-keyword">SELECT</span> [<span class="hljs-string">&#x27;AA&#x27;</span>,<span class="hljs-string">&#x27;BB&#x27;</span>,<span class="hljs-string">&#x27;CC&#x27;</span>,<span class="hljs-string">&#x27;DD&#x27;</span>,<span class="hljs-string">&#x27;EE&#x27;</span>,<span class="hljs-string">&#x27;FF&#x27;</span>,<span class="hljs-string">&#x27;GG&#x27;</span>]<br>)<span class="hljs-keyword">AS</span> dict<br><span class="hljs-keyword">SELECT</span> number <span class="hljs-keyword">AS</span> user_id, dict[number<span class="hljs-operator">%</span><span class="hljs-number">7</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>], now() <span class="hljs-keyword">AS</span> create_time <span class="hljs-keyword">FROM</span> <br>numbers(<span class="hljs-number">500000</span>);<br><br><span class="hljs-comment">-- 统计数据总量</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>() <span class="hljs-keyword">FROM</span> test_a;<br><br><span class="hljs-comment">-- 还未触发分区合并，所以还未去重。</span><br>┌──<span class="hljs-built_in">count</span>()──┐<br>│   <span class="hljs-number">10500000</span>   │<br>└────────┘<br></code></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="手动OPTIMIZE"><a href="#手动OPTIMIZE" class="headerlink" title="手动OPTIMIZE"></a>手动OPTIMIZE</h4><p>在写入数据后，立刻执行 OPTIMIZE 强制触发新写入分区的合并动作，不推荐，会触发数据的大量读写。 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">OPTIMIZE <span class="hljs-keyword">TABLE</span> test_a <span class="hljs-keyword">FINAL</span>;<br><br><span class="hljs-comment">-- 语法</span><br>OPTIMIZE <span class="hljs-keyword">TABLE</span> [db.]name [<span class="hljs-keyword">ON</span> CLUSTER cluster] [<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">partition</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">PARTITION</span> ID <span class="hljs-string">&#x27;partition_id&#x27;</span>] [<span class="hljs-keyword">FINAL</span>] [DEDUPLICATE [<span class="hljs-keyword">BY</span> expression]]<br></code></pre></td></tr></table></figure><h4 id="通过Group-by去重"><a href="#通过Group-by去重" class="headerlink" title="通过Group by去重"></a>通过Group by去重</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 执行去重的查询</span><br><span class="hljs-keyword">SELECT</span><br> user_id ,<br> argMax(score, create_time) <span class="hljs-keyword">AS</span> score, <br> argMax(deleted, create_time) <span class="hljs-keyword">AS</span> deleted,<br> <span class="hljs-built_in">max</span>(create_time) <span class="hljs-keyword">AS</span> ctime <br><span class="hljs-keyword">FROM</span> test_a <br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id<br><span class="hljs-keyword">HAVING</span> deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- 创建视图，方便测试</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> view_test_a <span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span><br> user_id ,<br> argMax(score, create_time) <span class="hljs-keyword">AS</span> score, <br> argMax(deleted, create_time) <span class="hljs-keyword">AS</span> deleted,<br> <span class="hljs-built_in">max</span>(create_time) <span class="hljs-keyword">AS</span> ctime <br><span class="hljs-keyword">FROM</span> test_a <br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id<br><span class="hljs-keyword">HAVING</span> deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- 插入重复数据，再次查询</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> test_a(user_id,score,create_time)<br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;AAAA&#x27;</span>,now());<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> view_test_a<br><span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- 插入一条标记为删除的数据</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> test_a(user_id,score,deleted,create_time) <br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;AAAA&#x27;</span>,<span class="hljs-number">1</span>,now());<br><br><span class="hljs-comment">-- 再次查询，刚才插入的数据查询不到了</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> view_test_a<br><span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>函数说明：</p><ul><li><p><strong>argMax(field1，field2)</strong>:按照 field2 的最大值取 field1 的值。</p><p>当我们更新数据时，会写入一行新的数据，例如上面语句中，通过查询最大的 create_time 得到修改后的 score 字段值。</p></li></ul><p><code>Notes：这行数据并没有被真正的删除，而是被过滤掉了。在一些合适的场景下，可以结合 表 级别的 TTL 最终将物理数据删除。</code></p><h4 id="通过FINAL查询"><a href="#通过FINAL查询" class="headerlink" title="通过FINAL查询"></a>通过FINAL查询</h4><p>在查询语句后增加 FINAL 修饰符，这样在查询的过程中将会执行 Merge 的特殊逻辑（例如数据去重，预聚合等）。</p><p>但是这种方法在早期版本基本没有人使用，因为在增加 FINAL 之后，我们的查询将会变成一个单线程的执行过程，查询速度非常慢。</p><p>在 <strong>v20.5.2.7-stable</strong> 版本中，FINAL 查询支持多线程执行，并且可以通过 <strong>max_final_threads</strong>  </p><p>参数控制单个查询的线程数。但是目前<strong>读取 part 部分的动作依然是串行的</strong>。</p><p>FINAL 查询最终的性能和很多因素相关，列字段的大小、分区的数量等等都会影响到最终的查询时间，所以还要结合实际场景取舍。 </p><h5 id="老版本-20-4-5-36（未测试）"><a href="#老版本-20-4-5-36（未测试）" class="headerlink" title="老版本 20.4.5.36（未测试）"></a>老版本 20.4.5.36（未测试）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 普通查询</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> visits_v1 <span class="hljs-keyword">WHERE</span> StartDate <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-03-17&#x27;</span> limit <span class="hljs-number">100</span>;<br><br><span class="hljs-comment">-- FINAL查询</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> visits_v1 <span class="hljs-keyword">FINAL</span> <span class="hljs-keyword">WHERE</span> StartDate <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2014-03-17&#x27;</span> limit <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure><h5 id="新版本-21-7-3-14"><a href="#新版本-21-7-3-14" class="headerlink" title="新版本 21.7.3.14"></a>新版本 21.7.3.14</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 普通查询</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> test_a<br><span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1970-01-01 08:00:00&#x27;</span><br>LIMIT <span class="hljs-number">100</span><br>SETTINGS max_threads <span class="hljs-operator">=</span> <span class="hljs-number">4</span><br><br><span class="hljs-comment">-- 耗时 0.007 sec</span><br><span class="hljs-number">100</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.007</span> sec. Processed <span class="hljs-number">720.74</span> thousand <span class="hljs-keyword">rows</span>, <span class="hljs-number">7.08</span> MB (<span class="hljs-number">106.42</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">1.05</span> GB<span class="hljs-operator">/</span>s.)<br><br><span class="hljs-comment">-- 使用FINAL字段</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> test_a<br><span class="hljs-keyword">FINAL</span><br><span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1970-01-01 08:00:00&#x27;</span><br>LIMIT <span class="hljs-number">100</span><br>SETTINGS max_threads <span class="hljs-operator">=</span> <span class="hljs-number">4</span><br><br><span class="hljs-comment">-- 耗时 0.049 sec</span><br><span class="hljs-number">100</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.049</span> sec. Processed <span class="hljs-number">1.24</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">28.95</span> MB (<span class="hljs-number">25.33</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">592.84</span> MB<span class="hljs-operator">/</span>s.)<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 普通查询</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>()<br><span class="hljs-keyword">FROM</span> test_a;<br><br>┌──<span class="hljs-built_in">count</span>()─┐<br>│ <span class="hljs-number">10500002</span>   │<br>└───────┘<br><br><span class="hljs-comment">-- 使用final进行后，根据排序字段去重了</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>()<br><span class="hljs-keyword">FROM</span><br>(<br>    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br>    <span class="hljs-keyword">FROM</span> test_a<br>    <span class="hljs-keyword">FINAL</span><br>);<br><br>┌──<span class="hljs-built_in">count</span>()─┐<br>│ <span class="hljs-number">10000000</span>   │<br>└───────┘<br></code></pre></td></tr></table></figure><h2 id="物化视图"><a href="#物化视图" class="headerlink" title="物化视图"></a>物化视图</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ClickHouse 的物化视图是一种<strong>查询结果的持久化</strong>，它确实是给我们带来了查询效率的提升。用户查起来跟表没有区别，它就是一张表，它也像是一张时刻在预计算的表，创建的过程它是用了一个特殊引擎。</p><h3 id="物化视图和普通视图的区别"><a href="#物化视图和普通视图的区别" class="headerlink" title="物化视图和普通视图的区别"></a>物化视图和普通视图的区别</h3><p>**<code>普通视图不保存数据，保存的仅仅是查询语句</code><strong>，查询的时候还是从原表读取数据，可以 将普通视图理解为是个子查询。</strong><code>物化视图则是把查询的结果根据相应的引擎存入到了磁盘或内存中</code>**，对数据重新进行了组织，你可以理解物化视图是完全的一张新表。</p><ul><li>优点：查询速度<code>快</code>，要是把物化视图这些规则全部写好，它比原数据查询快了很多，总的行数少了，因为都预计算好了。</li><li>缺点：它的本质是一个流式数据的使用场景，是累加式的技术，所以要用历史数据做去重、去核这样的分析，在物化视图里面是不太好用的。在某些场景的使用也是有限的。而且如果一张表加了好多物化视图，在写这张表的时候，就会消耗很多机器的资源，比如数据带宽占满、存储一下子增加了很多。</li></ul><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建物化视图语法</span><br><span class="hljs-keyword">CREATE</span> [MATERIALIZED] <span class="hljs-keyword">VIEW</span> [IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span>] [db.]table_name [<span class="hljs-keyword">TO</span>[db.]name] <br>[ENGINE <span class="hljs-operator">=</span> engine] [POPULATE] <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> ...<br></code></pre></td></tr></table></figure><ul><li>生产环境不建议添加<code>POPULATE</code>参数，它会将历史数据也放入视图中，造成表在计算历史数据时的不可用，如果一定要历史数据可单独计算后，使用<code>Insert语句插入到视图</code></li></ul><h3 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建测试表</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> trips_test<br>(<br>    `trip_id` UInt32,<br>    `pickup_date` <span class="hljs-type">Date</span>,<br>    `pickup_datetime` DateTime,<br>    `pickup_cdeligibil` String,<br>    `tip_amount` Float32 <br>)<br>ENGINE <span class="hljs-operator">=</span> MergeTree<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(pickup_date)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pickup_datetime<br>SETTINGS index_granularity <span class="hljs-operator">=</span> <span class="hljs-number">8192</span><br><br><span class="hljs-comment">-- 导入测试数据</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_test <span class="hljs-keyword">SELECT</span><br>    trip_id,<br>    pickup_date,<br>    pickup_datetime,<br>    pickup_cdeligibil,<br>    tip_amount<br><span class="hljs-keyword">FROM</span> trips;<br><br><span class="hljs-comment">-- 创建物化视图</span><br><span class="hljs-keyword">CREATE</span> MATERIALIZED <span class="hljs-keyword">VIEW</span> trips_test_mv<br>ENGINE<span class="hljs-operator">=</span>SummingMergeTree<br><span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> toYYYYMM(pickup_date) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pickup_date <br><span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span><br>trip_id,<br>pickup_date,<br><span class="hljs-built_in">sum</span>(tip_amount) <span class="hljs-keyword">AS</span> tip_amount_sum<br><span class="hljs-keyword">FROM</span> trips_test<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> trip_id,pickup_date;<br><br><span class="hljs-comment">-- 或者可以用下列语法，表A 可以是一张 mergetree 表</span><br><span class="hljs-comment">-- 如果不指定表A，物化视图的表名称为：.inner_id.表B_id</span><br><span class="hljs-comment">-- 如此格式：.inner_id.bb9b7351-2645-4f9e-bb9b-73512645af9e</span><br><span class="hljs-comment">-- 语法存在问题</span><br><span class="hljs-keyword">CREATE</span> MATERIALIZED <span class="hljs-keyword">VIEW</span> 物化视图名 <span class="hljs-keyword">TO</span> 表A<br><span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">FROM</span> 表B; <br><br><span class="hljs-comment">-- 不建议添加 populate 关键字进行全量更新,最好使用插入语句计算历史数据</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> trips_test_mv <span class="hljs-keyword">SELECT</span><br>    trip_id,<br>    pickup_date,<br>    <span class="hljs-built_in">sum</span>(tip_amount) <span class="hljs-keyword">AS</span> tip_amount_sum<br><span class="hljs-keyword">FROM</span> trips_test<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>    trip_id,<br>    pickup_date;<br></code></pre></td></tr></table></figure><h2 id="MetarializeMySQL引擎"><a href="#MetarializeMySQL引擎" class="headerlink" title="MetarializeMySQL引擎"></a>MetarializeMySQL引擎</h2><p>MySQL 的用户群体很大，为了能够增强数据的实时性，很多解决方案会利用 binlog 将数据写入到 ClickHouse。为了能够监听 binlog 事件，我们需要用到类似 canal 这样的第三方中间件，这无疑增加了系统的复杂度。</p><p><code>ClickHouse 20.8.2.3 版本</code>新增加了 MaterializeMySQL 的 database 引擎，该 database 能映 射 到 MySQL 中 的 某 个 database ， 并 自 动 在 ClickHouse 中 创建对应的ReplacingMergeTree。ClickHouse 服务做为 MySQL 副本，读取Binlog 并执行 DDL 和 DML 请求，实现了基于 MySQL Binlog 机制的业务数据库实时同步功能。</p><p><strong><code>Notes：物化MySqL的前提是：数据库里的表都是有主键的！！！</code></strong></p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li><p>MaterializeMySQL 同时支持<code>全量和增量</code>同步，在 database 创建之初会全量同步MySQL 中的表和数据，之后则会通过 binlog 进行增量同步。</p></li><li><p>MaterializeMySQL database 为其所创建的每张 ReplacingMergeTree 自动增加了_sign 和 _version 字段。其中，_version 用作 ReplacingMergeTree 的 ver 版本参数，每当监听到 insert、update 和 delete 事件时，在 databse 内全局自增。而 _sign 则用于标记是否被删除，取值 1 或者 -1。</p><p>目前 MaterializeMySQL 支持如下几种 binlog 事件:</p><ul><li>MYSQL_WRITE_ROWS_EVENT: _sign &#x3D; 1，_version ++</li><li>MYSQL_DELETE_ROWS_EVENT: _sign &#x3D; -1，_version ++</li><li>MYSQL_UPDATE_ROWS_EVENT: 新数据 _sign &#x3D; 1</li><li>MYSQL_QUERY_EVENT: 支持 CREATE TABLE 、DROP TABLE 、RENAME TABLE 等。</li></ul></li></ul><p><strong>使用细则</strong> </p><ul><li><p>DDL查询</p><p>MySQL DDL 查询被转换成相应的 ClickHouse DDL 查询（ALTER, CREATE, DROP, RENAME）。如果 ClickHouse 不能解析某些 DDL 查询，该查询将被忽略。</p></li><li><p>数据复制</p><p>MaterializeMySQL 不支持直接插入、删除和更新查询，而是将 DDL 语句进行相应转换： </p><ul><li>MySQL INSERT 查询被转换为 INSERT with _sign&#x3D;1</li><li>MySQL DELETE 查询被转换为 INSERT with _sign&#x3D;-1</li><li>MySQL UPDATE 查询被转换成 INSERT with _sign&#x3D;1 和 INSERT with _sign&#x3D;-1</li></ul></li><li><p>select查询</p><p>如果在 SELECT 查询中没有指定_version，则使用 FINAL 修饰符，返回_version 的最大值对应的数据，即最新版本的数据。</p><p>如果在 SELECT 查询中没有指定_sign，则默认使用 WHERE _sign&#x3D;1，即返回未删除状态 (_sign&#x3D;1)的数据。</p></li><li><p>索引转换</p><p>ClickHouse 数据库表会自动将 MySQL 主键和索引子句转换为 ORDER BY 元组。</p><p>ClickHouse 只有一个物理顺序，由 ORDER BY 子句决定。如果需要创建新的物理顺序，请使用物化视图</p></li></ul><h3 id="案例实操"><a href="#案例实操" class="headerlink" title="案例实操"></a>案例实操</h3><ol><li><p>修改Mysql配置</p><ol><li><p>确保 MySQL 开启了 <code>binlog 功能</code>，且格式为 <code>ROW</code> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/my.cnf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加内容</span><br>server-id=1 <br>log-bin=mysql-bin<br>binlog_format=ROW<br></code></pre></td></tr></table></figure></li><li><p>开启 <code>GTID 模式</code></p><p>如果如果 <code>clickhouse 使用的是 20.8 prestable 之后发布的版本</code>，那么 MySQL 还需要配置开启 GTID 模式, 这种方式在 mysql 主从模式下可以确保数据同步的一致性(主从切换时)。 </p><p><code>GTID是MySQL复制增强版</code>，从<code>MySQL 5.6版</code>本开始支持，目前已经是MySQL主流复制模式。它为每个 event分配一个全局唯一ID和序号，我们可以不用关心MySQL集群主从拓扑结构，直接告知MySQL这个GTID即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/my.cnf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加内容</span><br>gtid-mode=on<br>enforce-gtid-consistency=1 # 设置为主从强一致性<br>log-slave-updates=1 # 记录日志<br></code></pre></td></tr></table></figure></li><li><p>配置完成重启mysql即可</p></li></ol></li><li><p>准备Mysql表和数据</p><ol><li><p>在 MySQL 中创建数据表并写入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建数据库</span><br><span class="hljs-keyword">CREATE</span> DATABASE testck;<br><br><span class="hljs-comment">-- 创建表</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `testck`.`t_organization` (<br> `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br> `code` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br> `name` text <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> `updatetime` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br> <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br> <span class="hljs-keyword">UNIQUE</span> KEY (`code`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `testck`.`t_user` ( <br> `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br> `code` <span class="hljs-type">int</span>,<br> <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB;<br><br><br><span class="hljs-comment">-- 插入数据</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> testck.t_organization (code, name,updatetime) <br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1000</span>,<span class="hljs-string">&#x27;Realinsight&#x27;</span>,NOW());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> testck.t_organization (code, name,updatetime) <br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1001</span>, <span class="hljs-string">&#x27;Realindex&#x27;</span>,NOW());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> testck.t_organization (code, name,updatetime) <br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1002</span>,<span class="hljs-string">&#x27;EDT&#x27;</span>,NOW());<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> testck.t_user (code) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure></li></ol></li><li><p>准备就绪后</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- clickhouse开启allow_experimental_database_materialize_mysql参数</span><br><span class="hljs-keyword">set</span> allow_experimental_database_materialize_mysql<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br><br><span class="hljs-comment">-- 创建mysql通道，若有多个数据库可用[&#x27;database1&#x27;,&#x27;database2&#x27;]进行配置</span><br><span class="hljs-keyword">CREATE</span> DATABASE test_binlog ENGINE <span class="hljs-operator">=</span> <br>MaterializeMySQL(<span class="hljs-string">&#x27;ip:3306&#x27;</span>,<span class="hljs-string">&#x27;database&#x27;</span>,<span class="hljs-string">&#x27;username&#x27;</span>,<span class="hljs-string">&#x27;password&#x27;</span>);<br></code></pre></td></tr></table></figure></li></ol><h2 id="常见问题可参考阿里平台"><a href="#常见问题可参考阿里平台" class="headerlink" title="常见问题可参考阿里平台"></a>常见问题可参考阿里平台</h2><p><a href="https://help.aliyun.com/document_detail/162815.html?spm=a2c4g.11186623.6.652.312e79bd17U8IO">阿里平台常见问题及解决方案</a></p><h1 id="Clikhouse监控"><a href="#Clikhouse监控" class="headerlink" title="Clikhouse监控"></a>Clikhouse监控</h1><p>使用Prometheus+Grafana的组合进行监控备份是比较流行的，而且简单易上手，可以集成很多框架，包括服务器的负载，其中<code>Prometheus负责收集各类系统的运行指标，Grafana负责可视化展示的部分</code></p><p>ClickHouse 从 <code>v20.1.2.4</code> 开始，内置了对接 Prometheus 的功能，配置的方式也很简单，可以将其作为 Prometheus 的 Endpoint 服务，从而自动的将 metrics 、 events 和 asynchronous_metrics 三张系统的表的数据发送给 Prometheus。 </p><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="https://prometheus.io/download/">Prometheus下载</a></p><p><a href="https://grafana.com/grafana/download">Grafana下载</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装-配置Prometheus"><a href="#安装-配置Prometheus" class="headerlink" title="安装&amp;配置Prometheus"></a>安装&amp;配置Prometheus</h3><ul><li><p>解压Prometheus</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf prometheus-2.34.0.linux-amd64.tar.gz -C /opt/<br></code></pre></td></tr></table></figure></li><li><p>修改配置文件，注意缩进问题 prometheus.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#添加 ClickHouse 监控配置</span><br><span class="hljs-comment"># 名称可以随便取</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">clickhouse-1</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-comment"># 如果有多个[&#x27;localhost01:9363&#x27;,&#x27;localhost02:9363&#x27;]</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;localhost:9363&#x27;</span>]<br></code></pre></td></tr></table></figure><ul><li><strong>global</strong> <strong>配置块：</strong>控制 Prometheus 服务器的全局配置<ul><li>scrape_interval：配置拉取数据的时间间隔，默认为 1 分钟。 </li><li>evaluation_interval：规则验证（生成 alert）的时间间隔，默认为 1 分钟。</li></ul></li><li><strong>rule_files</strong> <strong>配置块：</strong>规则配置文件</li><li><strong>scrape_configs</strong> <strong>配置块：</strong>配置采集目标相关， prometheus 监视的目标。Prometheus 自身的运行信息可以通过 HTTP 访问，所以 Prometheus 可以监控自己的运行数据。 <ul><li>job_name：监控作业的名称 </li><li>static_configs：表示静态目标配置，就是固定从某个 target 拉取数据 </li><li>targets ： 指 定 监 控 的 目 标 ， 其 实 就 是 从 哪 儿 拉 取 数 据 。 Prometheus 会 从 <a href="http://localhost:9090/metrics">http://localhost:9090/metrics</a> 上拉取数据。</li></ul></li></ul></li></ul><h3 id="启动Prometheus"><a href="#启动Prometheus" class="headerlink" title="启动Prometheus"></a>启动Prometheus</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Prometheus 是可以在运行时自动加载配置的。启动时需要添加：--web.enable-lifecycle</span><br><br>nohup ./prometheus --config.file=prometheus.yml &gt; ./prometheus.log 2&gt;&amp;1 &amp;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">访问地址</span><br>http://localhost:9090<br></code></pre></td></tr></table></figure><h3 id="安装-启动Grafana"><a href="#安装-启动Grafana" class="headerlink" title="安装&amp;启动Grafana"></a>安装&amp;启动Grafana</h3><p><a href="https://grafana.com/grafana/dashboards">监控数据模板下载</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载Grafana</span><br>wget https://dl.grafana.com/enterprise/release/grafana-enterprise-8.4.6.linux-amd64.tar.gz<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">解压</span><br>tar -zxvf grafana-enterprise-8.4.6.linux-amd64.tar.gz -C /opt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>nohup ./bin/grafana-server web &gt; ./grafana.log 2&gt;&amp;1 &amp;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">web页面，默认用户名密码：admin</span><br>http://localhost:3000<br></code></pre></td></tr></table></figure><h2 id="配置Clickhouse"><a href="#配置Clickhouse" class="headerlink" title="配置Clickhouse"></a>配置Clickhouse</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 打开默认配置，重启CK即可 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">prometheus</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">endpoint</span>&gt;</span>/metrics<span class="hljs-tag">&lt;/<span class="hljs-name">endpoint</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>9363<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">metrics</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">metrics</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">events</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">events</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">asynchronous_metrics</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">asynchronous_metrics</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">status_info</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">status_info</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">prometheus</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="Clikchouse备份"><a href="#Clikchouse备份" class="headerlink" title="Clikchouse备份"></a>Clikchouse备份</h1><ul><li>手动备份及回复</li><li>第三方工具：<a href="https://github.com/AlexAkulov/clickhouse-backup">clickhouse-backup</a></li></ul><h2 id="相关参考文档"><a href="#相关参考文档" class="headerlink" title="相关参考文档"></a>相关参考文档</h2><p> <a href="https://www.cnblogs.com/ya-qiang/p/13566111.html">https://www.cnblogs.com/ya-qiang/p/13566111.html</a> </p><p> <a href="https://cloud.tencent.com/developer/article/1602662">https://cloud.tencent.com/developer/article/1602662</a> </p><p><a href="https://www.cnblogs.com/DBArtist/p/13603198.html">https://www.cnblogs.com/DBArtist/p/13603198.html</a></p><p><a href="https://juejin.cn/post/6897042422761521159">https://juejin.cn/post/6897042422761521159</a></p><p><a href="https://jiamaoxiang.top/2020/11/17/%E7%AC%AC%E4%BA%94%E7%AF%87-ClickHouse%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5-Flink%E3%80%81Spark%E3%80%81Kafka%E3%80%81MySQL/">https://jiamaoxiang.top/2020/11/17/%E7%AC%AC%E4%BA%94%E7%AF%87-ClickHouse%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5-Flink%E3%80%81Spark%E3%80%81Kafka%E3%80%81MySQL/</a></p><p> <a href="https://www.cnblogs.com/laoqing/p/15112701.html">https://www.cnblogs.com/laoqing/p/15112701.html</a> ?</p>]]></content>
    
    
    
    <tags>
      
      <tag>BigData</tag>
      
      <tag>Database</tag>
      
      <tag>Clickhouse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xsync</title>
    <link href="/2023/12/22/xsync/"/>
    <url>/2023/12/22/xsync/</url>
    
    <content type="html"><![CDATA[<h3 id="使用前提："><a href="#使用前提：" class="headerlink" title="使用前提："></a>使用前提：</h3><ul><li><p><strong>需要安装rsync</strong></p><ul><li><pre><code class="shell">yum -y install rsync xinetd<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs clean"><br>- **需要配置SSH免密登录**<br>- **需要配置环境环境变量**<br>- **需要修改第二步中的集群名称**<br><br>~~~shell<br>#!/bin/bash<br>#<span class="hljs-number">1.</span> 判断参数个数<br><span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]<br>then<br>  echo Not Enough Arguement!<br>  exit;<br>fi<br>##################### 记得修改需要遍历所有机器节点 ########################<br>#<span class="hljs-number">2.</span> 遍历集群所有机器<br>for host <span class="hljs-keyword">in</span> hadoop01 hadoop02<br>do<br>  echo ====================  $host  ====================<br>  #<span class="hljs-number">3.</span> 遍历所有目录，挨个发送<br>  for file <span class="hljs-keyword">in</span> $@<br>  do<br>    #<span class="hljs-number">4</span> 判断文件是否存在<br>    <span class="hljs-keyword">if</span> [ -e $file ]<br>    then<br>      #<span class="hljs-number">5.</span> 获取父目录<br>      pdir=$(cd -P $(dirname $file); pwd)<br>      #<span class="hljs-number">6.</span> 获取当前文件的名称<br>      fname=$(basename $file)<br>      #<span class="hljs-number">7.</span> 可以针对ssh端口进行修改，如果默认是<span class="hljs-number">22</span>端口则不需要填写<br>      ssh $host -p <span class="hljs-number">8022</span> <span class="hljs-string">&quot;mkdir -p $pdir&quot;</span><br>      rsync -e <span class="hljs-string">&#x27;ssh -p8022&#x27;</span> -av $pdir/$fname $host:$pdir<br>    else<br>      echo $file does not exists!<br>    fi<br>  done<br>done<br></code></pre></td></tr></table></figure></code></pre></li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Shell</tag>
      
      <tag>xsync</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zookeeper</title>
    <link href="/2023/12/22/Zookeeper/"/>
    <url>/2023/12/22/Zookeeper/</url>
    
    <content type="html"><![CDATA[<h1 id="Zookeeper教程"><a href="#Zookeeper教程" class="headerlink" title="Zookeeper教程"></a>Zookeeper教程</h1><p><a href="https://zookeeper.apache.org/">Zookeeper官方网站</a></p><h2 id="重点内容"><a href="#重点内容" class="headerlink" title="重点内容"></a>重点内容</h2><ul><li>Zookeeper分布式锁案例</li><li>Paxos算法</li><li>ZAB协议</li><li>CAP</li><li>源码（ZK服务端初始化源码、服务端加载数据源码、选举算法、状态同步算法、Leader启动算法、Follower启动源码、客户端启动源码）</li></ul><h2 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h2><ol><li>Zookeeper：一个Leader，多个Follower组成的集群</li><li>集群只要<strong>半数以上节点存活</strong>，zk集群服务就能正常使用，所以zk适合安装奇数台服务器</li><li>全局数据一致：每个server保存一份相同的数据副本，client无论连接哪个server，数据都是一致的</li><li>更新请求顺序执行，来自同一个client的更新请求按其发送顺序一次执行</li><li>数据更新原子性，一次数据更新要么成功，要么失败</li><li>实时性，在一定时间范围内，client能读到最新数据</li></ol><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul><li>统一命名服务</li><li>统一配置管理</li><li>统一集群管理</li><li>服务器动态上下线</li><li>软负载均衡</li></ul><h2 id="单机安装"><a href="#单机安装" class="headerlink" title="单机安装"></a>单机安装</h2><ol><li><p>安装JDK</p></li><li><p>上传 <strong>apache-zookeeper-3.5.7-bin.tar.gz</strong>，并解压到指定路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz -C /opt/module<br></code></pre></td></tr></table></figure></li><li><p>修改配置文件，修改数据存储路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建数据存储文件夹</span><br>[root@hadoop01 zookeeper-3.5.7]# mkdir zkData<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改zk数据存储路径，其余参数不需要修改</span><br>[root@hadoop01 conf]# vim zoo.cfg<br>dataDir=/opt/module/zookeeper-3.5.7/zkData<br></code></pre></td></tr></table></figure></li><li><p>启动zk服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动zk服务</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkServer.sh start conf/zoo.cfg <br>ZooKeeper JMX enabled by default<br>Using config: conf/zoo.cfg<br>Starting zookeeper ... STARTED<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看zk服务状态</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkServer.sh status<br>ZooKeeper JMX enabled by default<br>Using config: /opt/module/zookeeper-3.5.7/bin/../conf/zoo.cfg<br>Client port found: 2181. Client address: localhost.<br>Mode: standalone<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">停止zk服务</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkServer.sh stop<br>ZooKeeper JMX enabled by default<br>Using config: /opt/module/zookeeper-3.5.7/bin/../conf/zoo.cfg<br>Stopping zookeeper ... STOPPED<br></code></pre></td></tr></table></figure></li><li><p>查看zk进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">jps</span><br>[root@hadoop01 zookeeper-3.5.7]# jps -l<br>2368 org.apache.zookeeper.server.quorum.QuorumPeerMain<br>2445 sun.tools.jps.Jps<br></code></pre></td></tr></table></figure></li></ol><h2 id="配置参数详解"><a href="#配置参数详解" class="headerlink" title="配置参数详解"></a>配置参数详解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">通信心跳时间，zk服务器与客户端心跳时间，单位毫秒</span><br>tickTime=2000<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">LF(Leader、Follower)初始通信时限，10个心跳时间（tickTime的数量）</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">即容忍多少个心跳时限连接</span><br>initLimit=10<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">LF同步通信时限，若超过该时限，Leader认为Follower挂掉，从服务器列表中删除Follower</span><br>syncLimit=5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">保存zk中的数据</span><br>dataDir=/opt/module/zookeeper-3.5.7/zkData<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">客户端连接端口，一般不修改</span><br>clientPort=2181<br></code></pre></td></tr></table></figure><h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><ol><li><p>集群规划</p><p><strong>思考：如果是10台服务器，需要安装多少台zk？</strong></p></li><li><p>配置好同步分发文件脚本</p><p><a href="xsync.md" title=":include">同步脚本</a></p></li><li><p>解压安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz -C /opt/module<br></code></pre></td></tr></table></figure></li><li><p>配置服务器编号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建数据存储目录</span><br>[root@hadoop01 zookeeper-3.5.7]# mkdir zkData<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在数据存储路径下创建myid文件,确保每台服务器均有唯一编号即可</span><br>[root@hadoop01 zkData]# vim myid<br>1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">同步分发配置过的zk</span><br>[root@hadoop01 module]# xsync zookeeper-3.5.7/<br></code></pre></td></tr></table></figure></li><li><p>配置zoo.cfg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">tickTime=2000<br><br>initLimit=10<br><br>syncLimit=5<br><br>dataDir=/opt/module/zookeeper-3.5.7/zkData<br><br>clientPort=2181<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加以下内容</span><br>server.1=hadoop01:2888:3888<br>server.2=hadoop02:2888:3888<br></code></pre></td></tr></table></figure><p><strong>server.A&#x3D;B:C:D，参数解释</strong></p><ul><li>A：表示第几台服务器，即myid所配置的对应值</li><li>B：服务器地址</li><li>C：Follower与Leader交换信息的端口</li><li>D：如果集群中的Leader挂掉，需要使用新的端口进行重新选举，选出新的Leader</li></ul></li><li><p>启动集群</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">每一台服务器全部启动zk服务即可</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkServer.sh start conf/zoo.cfg <br>ZooKeeper JMX enabled by default<br>Using config: conf/zoo.cfg<br>Starting zookeeper ... STARTED<br><br>[root@hadoop02 zookeeper-3.5.7]# bin/zkServer.sh start conf/zoo.cfg<br>ZooKeeper JMX enabled by default<br>Using config: conf/zoo.cfg<br>Starting zookeeper ... STARTED<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看zk服务状态</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkServer.sh status<br>ZooKeeper JMX enabled by default<br>Using config: /opt/module/zookeeper-3.5.7/bin/../conf/zoo.cfg<br>Client port found: 2181. Client address: localhost.<br>Mode: follower<br><br>[root@hadoop02 zookeeper-3.5.7]# bin/zkServer.sh status<br>ZooKeeper JMX enabled by default<br>Using config: /opt/module/zookeeper-3.5.7/bin/../conf/zoo.cfg<br>Client port found: 2181. Client address: localhost.<br>Mode: leader<br></code></pre></td></tr></table></figure></li></ol><h2 id="zookeeper可视化工具（-PrettyZoo-）"><a href="#zookeeper可视化工具（-PrettyZoo-）" class="headerlink" title="zookeeper可视化工具（  PrettyZoo ）"></a>zookeeper可视化工具（  PrettyZoo ）</h2><p>PrettyZoo下载地址：<a href="https://github.com/vran-dev/PrettyZoo/releases">https://github.com/vran-dev/PrettyZoo/releases</a></p><p>Windows：prettyZoo-win.msi</p><p>Mac: prettyZoo-mac.dmg</p><p>Linux: prettyZoo-rpm &#x2F; prettyZoo.deb</p><h2 id="ZK选举机制"><a href="#ZK选举机制" class="headerlink" title="ZK选举机制"></a>ZK选举机制</h2><img src="/2023/12/22/Zookeeper/1638500972903.png" class="" width="1638500972903"><h3 id="第一次启动"><a href="#第一次启动" class="headerlink" title="第一次启动"></a>第一次启动</h3><ol><li>Server1启动，发起第一次选举，Server1投票给自己，此时Server1为1票，不够半数以上（3票），选举无法完成，Server1保持LOOKING状态</li><li>Server2启动，发起选举，<strong>Server1和Server2分别投自己一票，1和2交换选票信息，1发现2投票的服务器的myid比自己选举投票的服务器myid大，1将自己的选票投给2，此时1为0票，2为2票，仍然未达到半数以上</strong>，选举未完成，1和2处在LOOKING状态</li><li>Server3启动，发起投票，<strong>1（投了2）、2（投了2）和3交换选票信息，发现3选举的服务器myid比自己选举投票的服务器myid大，1、2改投3，此时1为0票，2为0票，3为3票（达到半数以上）</strong>，1、2修改状态为FOLLWING，3修改状态为LEADING</li><li>Server4启动，发起一次选举，<strong>此时1、2、3没有处在LOOKING状态，不修改选票信息，4少数服从多数，将选票投给3，此时3为4票，4为0票，4修改状态为FOLLWING</strong></li><li>Server5启动，发起一次选举，此时1、2、3、4没有处在LOOKING状态，不修改选票信息，5少数服从多数，将选票投给3，此时3为5票，5为0票，5修改状态为FOLLOWING</li></ol><h3 id="非第一次启动"><a href="#非第一次启动" class="headerlink" title="非第一次启动"></a>非第一次启动</h3><ol><li><p>当ZK集群中的一台S服务器出现以下两种情况时，就会开始进入Leader选举：</p><ul><li>服务器初始化，相当于添加服务器到ZK集群</li><li>服务器运行期间无法和Leader服务器保持连接</li></ul></li><li><p>当一台机器进入Leader选举流程时，当前集群可能存在以下两种状态：</p><ul><li><p>集群中的Leader仍然存在。服务器试图选举时，会被告知Leader的信息，对该服务器来说，只需要和Leader建立连接，并进行状态的同步即可</p></li><li><p>集群中的Leader确实不存在了。</p><p>假设ZK集群有5台服务器组成，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，并且SID为3的服务器是Leader。某一时刻3、5服务器出现故障，因为开始进行Leader选举：</p><pre><code class="hljs">                    括号中的参数顺序为：（EPOCH，ZXID，SID）</code></pre><p>SID为1、2、4的机器投票情况为：（1，8，1） （1，8，2）（1，7，4）<strong>最终2为Leader</strong></p><p><strong>比较顺序为：</strong></p><ul><li><strong>EPOCH大时，投票给EPOCH大的</strong></li><li><strong>EPOCH相同，投票给ZXID大的</strong></li><li><strong>EPOCH、ZXID相同时，投给SID大的</strong></li></ul></li></ul></li></ol><h2 id="集群启动脚本"><a href="#集群启动脚本" class="headerlink" title="集群启动脚本"></a>集群启动脚本</h2><p>编写集群启动脚本，记得修改脚本中的主机名称为对应集群的主机名称</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>case $1 in<br>&quot;start&quot;)&#123;<br>for i in hadoop01 hadoop02<br>do<br>echo -------------------- Zookeeper $i 启动 ------------------------<br>ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh start /opt/module/zookeeper-3.5.7/conf/zoo.cfg&quot;<br>done<br>&#125;<br>;;<br>&quot;stop&quot;)&#123;<br>for i in hadoop01 hadoop02<br>do<br>echo -------------------- Zookeeper $i 停止 ------------------------<br>ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh stop&quot;<br>done<br>&#125;<br>;;<br>&quot;status&quot;)&#123;<br>for i in hadoop01 hadoop02<br>do<br>echo -------------------- Zookeeper $i 状态 ------------------------<br>ssh $i &quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh status&quot;<br>done<br>&#125;<br>;;<br>esac<br></code></pre></td></tr></table></figure><h2 id="ZK客户端"><a href="#ZK客户端" class="headerlink" title="ZK客户端"></a>ZK客户端</h2><ul><li><p>启动客户端以及节点的相关参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动客户端</span><br>[root@hadoop01 ~]# cd /opt/module/zookeeper-3.5.7<br>[root@hadoop01 zookeeper-3.5.7]# bin/zkCli.sh -server hadoop01:2181<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动后查看节点参数</span><br>[zk: hadoop01:2181(CONNECTED) 3] ls -s /<br>[zookeeper]<br>cZxid = 0x0# 创建节点的事务ID<br>ctime = Thu Jan 01 08:00:00 CST 1970# znode被创建的毫秒数<br>mZxid = 0x0# znode最后更新的事务ID<br>mtime = Thu Jan 01 08:00:00 CST 1970# znode最后更新的时间<br>pZxid = 0x0# znode最后更新的子节点的zxid<br>cversion = -1# znode子节点变化号，znode子节点修改次数<br>dataVersion = 0# znode数据变化号<br>aclVersion = 0# znode访问控制列表的变化号<br>ephemeralOwner = 0x0 # 如果是临时节点，这个是znode拥有者的session id。如果不是临时节点则为0<br>dataLength = 0# znode的数据长度<br>numChildren = 1# znode的子节点数量<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">获取节点的值</span><br>[zk: hadoop01:2181(CONNECTED) 12] get -s /sanguo<br>sanguo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改节点的值</span><br>[zk: hadoop01:2181(CONNECTED) 2] set /sanguo &quot;luoguanzhong&quot;<br>[zk: hadoop01:2181(CONNECTED) 3] get /sanguo<br>luoguanzhong<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除单个节点</span><br>[zk: hadoop01:2181(CONNECTED) 4] delete /sanguo/weiguo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">递归删除节点及子节点</span><br>[zk: hadoop01:2181(CONNECTED) 5] deleteall /sanguo<br></code></pre></td></tr></table></figure></li><li><p>监听器</p><ul><li>监听节点的值</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">监听节点值得变化,注册一次就只能够监听一次</span><br>[zk: localhost:2181(CONNECTED) 1] get -w /sanguo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">当节点的之发生变化时</span><br>[zk: localhost:2181(CONNECTED) 2] <br>WATCHER::<br><br>WatchedEvent state:SyncConnected type:NodeDataChanged path:/sanguo<br></code></pre></td></tr></table></figure><ul><li>监听节点子节点的变化</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">监听节点值得变化,注册一次就只能够监听一次</span><br>[zk: localhost:2181(CONNECTED) 1] ls -w /sanguo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">当节点的之发生变化时</span><br>[zk: localhost:2181(CONNECTED) 2] <br>WATCHER::<br><br>WatchedEvent state:SyncConnected type:NodeDataChanged path:/sanguo<br></code></pre></td></tr></table></figure></li></ul><h3 id="ZK节点类型"><a href="#ZK节点类型" class="headerlink" title="ZK节点类型"></a>ZK节点类型</h3><ul><li>持久（Persistent）：客户端和服务端断开连接后，创建的节点不删除</li><li>临时（Ephemeral）：客户端和服务端断开连接后，创建的节点被删除</li><li>无序节点：创建的节点名称后不自动添加序号</li><li>有序节点：创建的节点名称后自动添加序号</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动客户端</span><br>[root@hadoop01 zookeeper-3.5.7]# bin/zkCli.sh -server hadoop01:2181<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建持久节点（无序）</span><br>[zk: hadoop01:2181(CONNECTED) 0] create /sanguo &quot;sanguo&quot;<br><br>[zk: hadoop01:2181(CONNECTED) 0] ls /<br>[sanguo, zookeeper]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建临时节点（无序）</span><br>[zk: hadoop01:2181(CONNECTED) 0] create -e /xiyou &quot;xiyou&quot;<br><br>[zk: hadoop01:2181(CONNECTED) 0] ls /<br>[sanguo, xiyou, zookeeper]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建有序持久节点</span><br>[zk: hadoop01:2181(CONNECTED) 0] create -s /sanguo &quot;sanguo&quot;<br><br>[zk: hadoop01:2181(CONNECTED) 6] ls /<br>[sanguo, sanguo0000000002, xiyou, zookeeper]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建有序临时节点</span><br>[zk: hadoop01:2181(CONNECTED) 0] create -e -s /xiyou &quot;xiyou&quot;<br><br>[zk: hadoop01:2181(CONNECTED) 8] ls /<br>[sanguo, sanguo0000000002, xiyou, xiyou0000000003, zookeeper]<br></code></pre></td></tr></table></figure><h3 id="ZK客户端API"><a href="#ZK客户端API" class="headerlink" title="ZK客户端API"></a>ZK客户端API</h3><ul><li>依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.12.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>相关代码</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bin.zk;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.*;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.data.Stat;<br><span class="hljs-keyword">import</span> org.junit.Before;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: zk客户端</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> YueCang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/6 15:41</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZkClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.24.10:2181,192.168.24.11:2181&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">sessionTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;<br>    <span class="hljs-keyword">private</span> ZooKeeper zkClient;<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        zkClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> &#123;<br>                <span class="hljs-comment">// 相关监听代码</span><br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nodeCreate</span> <span class="hljs-operator">=</span> zkClient.create(<span class="hljs-string">&quot;/bin&quot;</span>,<br>                <span class="hljs-string">&quot;ceshi&quot;</span>.getBytes(),<br>                ZooDefs.Ids.OPEN_ACL_UNSAFE,<br>                CreateMode.PERSISTENT_SEQUENTIAL);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getChildren</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        List&lt;String&gt; children = zkClient.getChildren(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-literal">true</span>);<br><br>        <span class="hljs-keyword">for</span> (String child : children) &#123;<br>            System.out.println(child);<br>        &#125;<br><br>        Thread.sleep(Long.MAX_VALUE);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exists</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        <span class="hljs-type">Stat</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> zkClient.exists(<span class="hljs-string">&quot;/bin&quot;</span>, <span class="hljs-literal">false</span>);<br><br>        System.out.println(stat == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;not exist&quot;</span> : <span class="hljs-string">&quot;exist&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ZK的写流程"><a href="#ZK的写流程" class="headerlink" title="ZK的写流程"></a>ZK的写流程</h3><ul><li><p><strong>将写入请求发送给Leader</strong></p><img src="/2023/12/22/Zookeeper/1638862817737.png" class="" width="1638862817737"><ol><li>client将写入请求发送给Leader，Leader自身首先写入</li><li>Leader将写入请求发送给Follower，Follower写入</li><li>Follower写入后应答Leader</li><li>当ZK Server写入的数量达到半数以上，应答Client</li><li>其他未写完的Server继续写入数据</li><li>写完后应答Leader</li></ol></li><li><p><strong>将写入请求发送给Follower</strong></p><img src="/2023/12/22/Zookeeper/1638865261438.png" class="" width="1638865261438"></li></ul><h2 id="案例一：监听ZK服务器上下限"><a href="#案例一：监听ZK服务器上下限" class="headerlink" title="案例一：监听ZK服务器上下限"></a>案例一：监听ZK服务器上下限</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bin.case1;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: 服务器注册</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> YueCang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/7 17:38</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributeServer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hadoop01:2181,hadoop02:2181&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">sessionTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;<br>    <span class="hljs-keyword">private</span> ZooKeeper zk;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException &#123;<br>        <span class="hljs-type">DistributeServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributeServer</span>();<br><br>        <span class="hljs-comment">// 1.连接zk</span><br>        server.getConnect();<br><br>        <span class="hljs-comment">// 2.注册</span><br>        server.regist(args[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-comment">// 3.处理业务</span><br>        server.business();<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">business</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        Thread.sleep(Long.MAX_VALUE);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">regist</span><span class="hljs-params">(String hostName)</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> zk.create(<span class="hljs-string">&quot;/servers/server&quot;</span>,<br>                hostName.getBytes(),<br>                ZooDefs.Ids.OPEN_ACL_UNSAFE,<br>                CreateMode.EPHEMERAL_SEQUENTIAL);<br><br>        System.out.println(hostName + <span class="hljs-string">&quot; is online&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        zk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> &#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bin.case1;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.KeeperException;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.WatchedEvent;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.Watcher;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.ZooKeeper;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: 客户端监听</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> YueCang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/7 17:02</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributeClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hadoop01:2181,hadoop02:2181&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">sessionTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;<br>    <span class="hljs-keyword">private</span> ZooKeeper zk;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException, IOException &#123;<br>        <span class="hljs-type">DistributeClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributeClient</span>();<br><br>        <span class="hljs-comment">// 1.获取连接</span><br>        client.getConnect();<br><br>        <span class="hljs-comment">// 2.获取服务器列表</span><br>        client.getServerList();<br><br>        <span class="hljs-comment">// 3.处理业务</span><br>        client.business();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">business</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        Thread.sleep(Long.MAX_VALUE);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getServerList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        List&lt;String&gt; children = zk.getChildren(<span class="hljs-string">&quot;/servers&quot;</span>, <span class="hljs-literal">true</span>);<br><br>        ArrayList&lt;String&gt; servers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (String child : children) &#123;<br>            <span class="hljs-type">byte</span>[] data = zk.getData(<span class="hljs-string">&quot;/servers/&quot;</span> + child, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>            servers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data));<br>        &#125;<br><br>        System.out.println(servers);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getConnect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        zk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    getServerList();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ZK分布式锁案例"><a href="#ZK分布式锁案例" class="headerlink" title="ZK分布式锁案例"></a>ZK分布式锁案例</h2><img src="/2023/12/22/Zookeeper/1638931402278.png" class="" width="1638931402278">  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bin.case2;<br><br><span class="hljs-keyword">import</span> org.apache.zookeeper.*;<br><span class="hljs-keyword">import</span> org.apache.zookeeper.data.Stat;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> YueCang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/8 10:47</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributeLock</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hadoop01:2181,hadoop02:2181&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">sessionTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ZooKeeper zk;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">waitLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">private</span> String waitPath;<br>    <span class="hljs-keyword">private</span> String currentMode;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributeLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException &#123;<br><br>        <span class="hljs-comment">// 连接ZK</span><br>        zk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(WatchedEvent watchedEvent)</span> &#123;<br>                <span class="hljs-comment">// countDownLatch 释放锁</span><br>                <span class="hljs-keyword">if</span>(watchedEvent.getState() == Event.KeeperState.SyncConnected)&#123;<br>                    countDownLatch.countDown();<br>                &#125;<br><br>                <span class="hljs-comment">// waitLatch 释放锁</span><br>                <span class="hljs-keyword">if</span>(watchedEvent.getType() == Event.EventType.NodeDeleted<br>                        &amp;&amp; watchedEvent.getPath().equals(waitPath));<br>                waitLatch.countDown();<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">// 等待ZK连接</span><br>        countDownLatch.await();<br><br>        <span class="hljs-comment">// 判断根节点/locks是否存在</span><br>        <span class="hljs-type">Stat</span> <span class="hljs-variable">rootExists</span> <span class="hljs-operator">=</span> zk.exists(<span class="hljs-string">&quot;/locks&quot;</span>, <span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">// 根节点不存在就创建根节点</span><br>        <span class="hljs-keyword">if</span>(rootExists == <span class="hljs-literal">null</span>)&#123;<br>            zk.create(<span class="hljs-string">&quot;/locks&quot;</span>,<span class="hljs-string">&quot;locks&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">zkLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        <span class="hljs-comment">// 创建有序临时节点</span><br>        currentMode = zk.create(<span class="hljs-string">&quot;/locks/seq-&quot;</span>,<br>                <span class="hljs-literal">null</span>,<br>                ZooDefs.Ids.OPEN_ACL_UNSAFE,<br>                CreateMode.EPHEMERAL_SEQUENTIAL);<br><br>        <span class="hljs-comment">// 判断当前节点是否是最小节点</span><br>        List&lt;String&gt; children = zk.getChildren(<span class="hljs-string">&quot;/locks&quot;</span>, <span class="hljs-literal">false</span>);<br><br>        <span class="hljs-keyword">if</span>(children.size() == <span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-comment">// 如果只有一个节点那么它必然是最小节点，直接返回即可</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            Collections.sort(children);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">currentNode</span> <span class="hljs-operator">=</span> currentMode.substring(<span class="hljs-string">&quot;/locks/&quot;</span>.length());<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> children.indexOf(currentNode);<br><br>            <span class="hljs-keyword">if</span>(index == -<span class="hljs-number">1</span>)&#123;<br>                <span class="hljs-comment">// 索引为-1说明数据有问题</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;参数异常&quot;</span>);<br>            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(index == <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">// 索引为0说明该节点就是最小节点</span><br>                <span class="hljs-keyword">return</span>;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 监听前一个节点变化</span><br>                waitPath = <span class="hljs-string">&quot;/locks/&quot;</span> + children.get(index -<span class="hljs-number">1</span>);<br>                zk.getData(waitPath,<span class="hljs-literal">true</span>,<span class="hljs-literal">null</span>);<br><br>                <span class="hljs-comment">// 等待前一步骤执行完毕，在执行</span><br>                waitLatch.await();<br><br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解锁</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">zkUnlock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException &#123;<br>        <span class="hljs-comment">// 删除节点</span><br>        zk.delete(currentMode,-<span class="hljs-number">1</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException, KeeperException &#123;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">DistributeLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributeLock</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock1.zkLock();<br>                    System.out.println(<span class="hljs-string">&quot;线程1获取锁&quot;</span>);<br>                    Thread.sleep(<span class="hljs-number">5</span>*<span class="hljs-number">1000</span>);<br>                    lock1.zkUnlock();<br>                    System.out.println(<span class="hljs-string">&quot;线程1释放锁&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">DistributeLock</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributeLock</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock2.zkLock();<br>                    System.out.println(<span class="hljs-string">&quot;线程2获取锁&quot;</span>);<br>                    Thread.sleep(<span class="hljs-number">5</span>*<span class="hljs-number">1000</span>);<br>                    lock2.zkUnlock();<br>                    System.out.println(<span class="hljs-string">&quot;线程2释放锁&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (KeeperException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="分布式锁成熟框架Curator"><a href="#分布式锁成熟框架Curator" class="headerlink" title="分布式锁成熟框架Curator"></a>分布式锁成熟框架Curator</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-recipes<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bin.case3;<br><br><span class="hljs-keyword">import</span> org.apache.curator.RetryPolicy;<br><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFramework;<br><span class="hljs-keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;<br><span class="hljs-keyword">import</span> org.apache.curator.framework.recipes.locks.InterProcessMutex;<br><span class="hljs-keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> YueCang</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/12/9 10:03</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CuratorLock</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="hljs-string">&quot;/locks&quot;</span>);<br><br>        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(getCuratorFramework(), <span class="hljs-string">&quot;/locks&quot;</span>);<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock1.acquire();<br>                    System.out.println(<span class="hljs-string">&quot;线程1获取到锁&quot;</span>);<br><br>                    lock1.acquire();<br>                    System.out.println(<span class="hljs-string">&quot;线程1再次获取到锁&quot;</span>);<br><br>                    Thread.sleep(<span class="hljs-number">5000</span>);<br><br>                    lock1.release();<br>                    System.out.println(<span class="hljs-string">&quot;线程1释放锁&quot;</span>);<br><br>                    lock1.release();<br>                    System.out.println(<span class="hljs-string">&quot;线程1再次释放锁&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock2.acquire();<br>                    System.out.println(<span class="hljs-string">&quot;线程2获取到锁&quot;</span>);<br><br>                    lock2.acquire();<br>                    System.out.println(<span class="hljs-string">&quot;线程2再次获取到锁&quot;</span>);<br><br>                    Thread.sleep(<span class="hljs-number">5000</span>);<br><br>                    lock2.release();<br>                    System.out.println(<span class="hljs-string">&quot;线程2释放锁&quot;</span>);<br><br>                    lock2.release();<br>                    System.out.println(<span class="hljs-string">&quot;线程2再次释放锁&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CuratorFramework <span class="hljs-title function_">getCuratorFramework</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-type">ExponentialBackoffRetry</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(<span class="hljs-number">3000</span>,<span class="hljs-number">3</span>);<br><br>        <span class="hljs-type">CuratorFramework</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> CuratorFrameworkFactory.builder()<br>                .connectString(<span class="hljs-string">&quot;hadoop01:2181,hadoop02:2181&quot;</span>)<br>                .connectionTimeoutMs(<span class="hljs-number">2000</span>)<br>                .sessionTimeoutMs(<span class="hljs-number">2000</span>)<br>                .retryPolicy(retryPolicy)<br>                .build();<br><br>        client.start();<br>        System.out.println(<span class="hljs-string">&quot;Zookeeper启动成功&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> client;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="企业面试题"><a href="#企业面试题" class="headerlink" title="企业面试题"></a>企业面试题</h2><h3 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h3><p>选举机制，超过半数的投票通过，即通过</p><ol><li><p>第一次启动选举规则：</p><p>投票过半数时，SID（服务器id）大的胜出</p></li><li><p>第二次启动选举规则：</p><ul><li>Epoch大的直接胜出</li><li>Epoch相同，ZXID（事务id）大的胜出</li><li>ZXID相同，SID（服务器id）大的胜出</li></ul></li></ol><h3 id="生产环境下集群安装多少台ZK合适"><a href="#生产环境下集群安装多少台ZK合适" class="headerlink" title="生产环境下集群安装多少台ZK合适"></a>生产环境下集群安装多少台ZK合适</h3><ul><li>安装奇数台</li><li>生产经验<ul><li>10台服务器，3台zk</li><li>20台服务器，5台zk</li><li>100台服务器，11台zk</li><li>200台服务器，11台zk</li></ul></li></ul><p><strong>Notes：服务器台数多的<code>好处</code>：提高了可靠性，<code>坏处</code>：提高了通信延迟</strong></p><h2 id="————-源码学习-————"><a href="#————-源码学习-————" class="headerlink" title="————-  源码学习 ————-"></a>————-  源码学习 ————-</h2><h2 id="拜占庭将军问题"><a href="#拜占庭将军问题" class="headerlink" title="拜占庭将军问题"></a>拜占庭将军问题</h2><blockquote><p>拜占庭将军问题（Byzantine failures），是由莱斯利·兰伯特提出的点对点通信中的基本问题。含义是在存在消息丢失的不可靠信道上试图通过消息传递的方式达到一致性是不可能的 </p></blockquote><h2 id="Paxos算法"><a href="#Paxos算法" class="headerlink" title="Paxos算法"></a>Paxos算法</h2><p><strong><code>Paxos算法：</code>一种基于消息传递且具有高度容错特性的一致性算法</strong></p><p><strong><code>解决的问题：</code>如何快速正确的在一个分布式系统中对某个数据值达成一致性，并且保证不论发生任何异常，都不会破坏整个系统的一致性</strong></p><p><strong>在一个Paxos算法系统中，首先将所有节点划分为Proposer（提议者），Acceptor（接收者），Learner（学习者）。</strong>（<strong>每个节点可能身兼数职</strong>）</p><ul><li>一个完整的Paxos算法流程分为三个阶段：</li></ul><h2 id="ZAB协议"><a href="#ZAB协议" class="headerlink" title="ZAB协议"></a>ZAB协议</h2><p><strong>ZAB协议内容：消息广播、崩溃恢复</strong></p>]]></content>
    
    
    
    <tags>
      
      <tag>BigData</tag>
      
      <tag>Zookeeper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CDH</title>
    <link href="/2023/12/21/CDH/"/>
    <url>/2023/12/21/CDH/</url>
    
    <content type="html"><![CDATA[<h1 id="CDH安装"><a href="#CDH安装" class="headerlink" title="CDH安装"></a>CDH安装</h1><ol><li><p>修改主机名称和host文件映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改主机名称，需全部进行修改</span><br>[root@hadoop0X ~]# hostnamectl set-hostname hadoop0X<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">host文件映射</span><br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.24.10 hadoop01 hadoop01<br>192.168.24.11 hadoop02 hadoop02<br>192.168.24.12 hadoop03 hadoop03<br></code></pre></td></tr></table></figure></li><li><p>关闭防火墙和Selinux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">关闭防火墙</span><br>systemctl stop firewalld<br>systemctl disable firewalld.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">关闭Selinux</span><br>vim /etc/selinux/config<br><span class="hljs-meta prompt_"># </span><span class="language-bash">This file controls the state of SELinux on the system.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">SELINUX= can take one of these three values:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    enforcing - SELinux security policy is enforced.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    permissive - SELinux prints warnings instead of enforcing.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    disabled - No SELinux policy is loaded.</span><br>SELINUX=disabled<br><span class="hljs-meta prompt_"># </span><span class="language-bash">SELINUXTYPE= can take one of three values:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    targeted - Targeted processes are protected,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    minimum - Modification of targeted policy. Only selected processes are protected.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">    mls - Multi Level Security protection.</span><br>SELINUXTYPE=targeted<br><br>setenforce 0    # 临时关闭selinux<br>getenforce      # 查看selinux状态<br></code></pre></td></tr></table></figure></li><li><p>SSH免密</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ssh免密</span><br>ssh-keygen -t rsa<br><br>ssh-copy-id hadoop01<br>ssh-copy-id hadoop02<br>ssh-copy-id hadoop03<br></code></pre></td></tr></table></figure></li><li><p>安装JDK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">将jdk解压到 /usr/java 下</span><br>tar -zxvf jdk-8u171-linux-x64.tar.gz -C /usr/java<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在/etc/profile文件中，配置环境变量</span><br>vim /etc/profile<br><br>export JAVA_HOME=/usr/java/jdk1.8.0_171<br>export JRE_HOME=/usr/java/jdk1.8.0_171/jre<br>export CLASSPATH=.:$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH<br>export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:/opt/user-bin:$PATH<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将文件分发给其他两台机器</span><br>scp -r /usr/java/ hadoop02:/usr<br>scp -r /usr/java/ hadoop03:/usr<br><br>scp /etc/profile hadoop02:/etc<br>scp /etc/profile hadoop03:/etc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使环境变量生效</span><br>[root@hadoop02 ~]# source /etc/profile<br>[root@hadoop03 ~]# source /etc/profile<br></code></pre></td></tr></table></figure><p><strong><code>Notes：</code>JDK安装路径一定要安装在 <code>/usr/java</code> 路径下，否则无法识别到JDK</strong></p></li><li><p>安装Mysql（两种方式任选其一）                                                   </p><ul><li><p>本地源安装mysql</p><ul><li><p>安装和启动httpd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装httpd</span><br>yum install -y httpd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动httpd</span><br>systemctl start httpd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br>systemctl enable httpd<br></code></pre></td></tr></table></figure></li><li><p>安装createrepo </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"> # </span><span class="language-bash">安装 createrepo</span><br>yum install -y createrepo<br> <br></code></pre></td></tr></table></figure></li><li><p>创建本地源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">createrepo /var/www/html/mysql_repos<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建文件 *.repo 一定要以repo为文件后缀名</span><br>touch /etc/yum.repos.d/mysql-local.repo<br>vim /etc/yum.repos.d/mysql-local.repo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">the RPMs of MySQL server</span><br>[mysql-local]<br>name=mysql-local<br>baseurl=http://hadoop01/mysql-repos<br>gpgcheck=0<br>enabled=1<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清空本地的yum源缓存</span><br>yum clean all<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重新生成元数据</span><br>yum makecache<br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用yum查看本地源文件</span><br>yum list | grep mysql-local<br></code></pre></td></tr></table></figure></li><li><p>安装Mysql（本地源形式）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装mysql</span><br>yum install -y mysql-community-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">初始化mysql</span><br>mysqld --initialize --user=mysql --console<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动mysql</span><br>systemctl start mysqld<br><span class="hljs-meta prompt_"># </span><span class="language-bash">开机自启</span><br>systemctl enable mysqld<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改字符集</span> <br>vim /etc/my.cnf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">For advice on how to change settings please see</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">&gt;&gt;&gt; 追加内容开始</span><br>[client]<br>port=3306<br>default-character-set=utf8<br>[mysql]<br>default-character-set=utf8<br><span class="hljs-meta prompt_"># </span><span class="language-bash">&lt;&lt;&lt; 追加内容结束</span><br>[mysqld]<br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Remove leading # and set to the amount of RAM for the most important data cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">innodb_buffer_pool_size = 128M</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Remove leading # to turn on a very important data integrity option: logging</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">changes to the binary <span class="hljs-built_in">log</span> between backups.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">log_bin</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Remove leading <span class="hljs-comment"># to set options mainly useful for reporting servers.</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">The server defaults are faster <span class="hljs-keyword">for</span> transactions and fast SELECTs.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">join_buffer_size = 128M</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sort_buffer_size = 2M</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">read_rnd_buffer_size = 2M</span><br>datadir=/var/lib/mysql<br>socket=/var/lib/mysql/mysql.sock<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Disabling symbolic-links is recommended to prevent assorted security risks</span><br>symbolic-links=0<br><br>log-error=/var/log/mysqld.log<br>pid-file=/var/run/mysqld/mysqld.pid<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">&gt;&gt;&gt; 追加内容开始</span><br>collation-server=utf8_general_ci<br>character_set_server=utf8<br><span class="hljs-meta prompt_"># </span><span class="language-bash">&lt;&lt;&lt; 追加内容结束</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重新启动mysql</span><br>systemctl restart mysqld<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看原始密码</span><br>cat /var/log/mysqld.log | grep password<br>2020-12-18T09:11:35.497638Z 1 [Note] A temporary password is generated for root@localhost: 97iE:I.&gt;T6ea<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">登录mysql</span><br>mysql -uroot -p97iE:I.&gt;T6ea<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改密码</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">alter user <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;Mysql@12#$&#x27;</span>;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看字符集，字符集需要都是utf8，否则插入中文会出现乱码</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="hljs-string">&#x27;character%&#x27;</span>;</span><br>+--------------------------+----------------------------+<br>| Variable_name            | Value                      |<br>+--------------------------+----------------------------+<br>| character_set_client     | utf8                       |<br>| character_set_connection | utf8                       |<br>| character_set_database   | utf8                       |<br>| character_set_filesystem | binary                     |<br>| character_set_results    | utf8                       |<br>| character_set_server     | utf8                       |<br>| character_set_system     | utf8                       |<br>| character_sets_dir       | /usr/share/mysql/charsets/ |<br>+--------------------------+----------------------------+<br><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 开启远程连接</span><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">User</span>,Host,authentication_string <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------------+-----------+-------------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">User</span>          <span class="hljs-operator">|</span> Host      <span class="hljs-operator">|</span> authentication_string                     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------+-----------+-------------------------------------------+</span><br><span class="hljs-operator">|</span> root          <span class="hljs-operator">|</span> localhost <span class="hljs-operator">|</span> <span class="hljs-operator">*</span><span class="hljs-number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mysql.session <span class="hljs-operator">|</span> localhost <span class="hljs-operator">|</span> <span class="hljs-operator">*</span>THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> mysql.sys     <span class="hljs-operator">|</span> localhost <span class="hljs-operator">|</span> <span class="hljs-operator">*</span>THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------------+-----------+-------------------------------------------+</span><br><br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">set</span> host<span class="hljs-operator">=</span><span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">where</span> host <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;localhost&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;root&#x27;</span>;<br><br>mysql<span class="hljs-operator">&gt;</span> flush privileges;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>阿里云centos7安装mysql8.0 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载安装mysql</span><br>sudo rpm -Uvh https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm<br>sudo yum -y install mysql-community-server --enablerepo=mysql80-community --nogpgcheck<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动mysql，查看初是密码</span><br>systemctl start mysqld<br>cat /var/log/mysqld.log | grep password<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改mysql默认密码</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">ALTER USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;Cdh@123456&#x27;</span>;</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">flush privileges;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">开启远程连接</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">update user <span class="hljs-built_in">set</span> host=<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-built_in">where</span> user=<span class="hljs-string">&#x27;root&#x27;</span>;</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">flush privileges;</span> <br></code></pre></td></tr></table></figure></li></ul></li><li><p>安装CM服务</p><ul><li><p>Mysql中创建元数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE scm <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">COLLATE</span>  utf8_general_ci;<br><br><span class="hljs-keyword">CREATE</span> DATABASE hive <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">COLLATE</span>  utf8_general_ci;<br><br><span class="hljs-keyword">CREATE</span> DATABASE oozie <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">COLLATE</span>  utf8_general_ci;<br><br><span class="hljs-keyword">CREATE</span> DATABASE hue <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">COLLATE</span>  utf8_general_ci;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;scm&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;Scm@1234&#x27;</span>;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;scm&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">GRANT</span> OPTION;<br>flush privileges;<br></code></pre></td></tr></table></figure></li><li><p>创建存放mysql驱动的文件目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /usr/share/java<br><br>cp mysql-connector-java.jar /usr/share/java/<br><br>scp -r /usr/share/java/ hadoop02:/usr/share/<br>scp -r /usr/share/java/ hadoop03:/usr/share/<br></code></pre></td></tr></table></figure></li><li><p>创建CM本地源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建本地源</span><br>createrepo /var/www/html/cloudera-repos/cm6/6.2.1/redhat7<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置本地源，创建文件 *.repo 一定要以repo为文件后缀名</span><br>touch /etc/yum.repos.d/cloudera-local.repo<br>vim /etc/yum.repos.d/cloudera-local.repo<br><br>[cloudera-local]<br>name=cloudera-local<br>baseurl=http://hadoop102/CDH6.3.2/cm6.3.1/RPMS/x86_64<br>gpgcheck=0<br>enabled=1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">同步repo文件</span><br>scp cloudera-local.repo hadoop02:/etc/yum.repos.d/<br>scp cloudera-local.repo hadoop03:/etc/yum.repos.d/<br><br>[root@hadoop0X ~]# yum clean all &amp;&amp; yum makecache<br>[root@hadoop0X ~]# yum list | grep cloudera<br>cloudera-manager-agent.x86_64               6.2.1-1426065.el7          cloudera-local<br>cloudera-manager-daemons.x86_64             6.2.1-1426065.el7          cloudera-local<br>cloudera-manager-server.x86_64              6.2.1-1426065.el7          cloudera-local<br>cloudera-manager-server-db-2.x86_64         6.2.1-1426065.el7          cloudera-local<br>enterprise-debuginfo.x86_64                 6.2.1-1426065.el7          cloudera-local<br>oracle-j2sdk1.8.x86_64                      1.8.0+update181-1          cloudera-local<br></code></pre></td></tr></table></figure></li><li><p>安装server，agent，daemons</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">所有节点都要安装daemons agent，只需要在服务节点安装server</span><br>[root@hadoop01 ~]# yum install -y cloudera-manager-daemons cloudera-manager-agent cloudera-manager-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改agent配置文件</span><br>vim /etc/cloudera-scm-agent/config.ini<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Hostname of the CM server.</span><br>server_host=hadoop01<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">分发agent配置文件</span><br>scp config.ini hadoop02:/etc/cloudera-scm-agent/<br>scp config.ini hadoop03:/etc/cloudera-scm-agent/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将离线文件放到/opt/cloudera/parcel-repo,此文件夹存放离线安装文件</span><br>cp CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha1 CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha256 manifest.json /opt/cloudera/parcel-repo/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">比较sha1和sha256校验码，一致的将文件名称改为*.sha</span><br>sha1sum CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel<br>d2a3d0be2524f37dbf686677cc45f3f8a3bd2cfd  CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel<br><br>cat CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha1<br>d2a3d0be2524f37dbf686677cc45f3f8a3bd2cfd<br><br>cat CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha256<br>8b6e51b900832a39c22fa6a778f8188836c25c99de3280c3ff81f17472deff72<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除不相同的，将相同的*.sha1改名为*.sha</span><br>mv CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha1 CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha<br>rm -rf CDH-6.2.1-1.cdh6.2.1.p0.1425774-el7.parcel.sha256<br>   <br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置server连接的数据库</span><br>vim /etc/cloudera-scm-server/db.properties<br>com.cloudera.cmf.db.type=mysql<br>com.cloudera.cmf.db.host=hadoop01<br>com.cloudera.cmf.db.name=scm<br>com.cloudera.cmf.db.user=root<br>com.cloudera.cmf.db.password=Cdh@123456<br>com.cloudera.cmf.db.setupType=EXTERNAL<br>   <br><span class="hljs-meta prompt_"># </span><span class="language-bash">执行初始化数据库脚本</span><br>/opt/cloudera/cm/schema/scm_prepare_database.sh mysql scm root Cdh@123456<br></code></pre></td></tr></table></figure></li></ul></li><li><p>启动server和agent</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看启动日志</span><br>[root@hadoop01 ~]# tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log<br>   <br>[root@hadoop01 ~]# systemctl start cloudera-scm-server<br>   <br>[root@hadoop0X ~]# systemctl start cloudera-scm-agent<br></code></pre></td></tr></table></figure><blockquote><p>启动成功后访问：hadoop102:7180</p><p>用户名：admin</p><p>密码：admin</p><p>ALTER USER root@localhost IDENTIFIED WITH mysql_native_password BY ‘Cdh@123456’;</p></blockquote><img src="/2023/12/21/CDH/1643100472883.png" class="" title="CM登录页面"></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>BigData</tag>
      
      <tag>CDH</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>定时任务</title>
    <link href="/2023/11/16/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    <url>/2023/11/16/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="Springboot集成定时任务"><a href="#Springboot集成定时任务" class="headerlink" title="Springboot集成定时任务"></a>Springboot集成定时任务</h1><h2 id="静态定时任务"><a href="#静态定时任务" class="headerlink" title="静态定时任务"></a>静态定时任务</h2><blockquote><p>静态定时任务是指应用跑起来后，任务的执行时间无法进行动态修改。</p></blockquote><h3 id="单线程定时任务"><a href="#单线程定时任务" class="headerlink" title="单线程定时任务"></a>单线程定时任务</h3><ol><li><p>使用注解开启定时任务 <strong>@EnableScheduling</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringbootQuartzApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SpringbootQuartzApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建任务 <strong>@Scheduled</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownLoadTask</span> &#123;<br><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/10 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">justDoIt</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始下载银行对账文件&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行对账文件下载完成，进行解密操作&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行对账文件下载解密完成&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>可按照需求进行任务执行时间</p><ol><li>cron：使用Cron表达式执行定时任务</li><li>fixedDelay：固定延迟执行，例如距离上次成功执行后5秒执行</li><li>fixedRate：固定速率执行，例如每隔5秒执行一次</li><li>initialDelay：初始延迟任务，例如任务开启5秒后执行，之后再以固定频率或者间隔执行</li></ol></li></ol><blockquote><p>Note：此方式只有一个调度线程执行任务，在多任务时，效果就会差很多</p></blockquote><h3 id="多线程定时任务"><a href="#多线程定时任务" class="headerlink" title="多线程定时任务"></a>多线程定时任务</h3><ol><li><p>定义线程池</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean(name = &quot;bankThreadPool&quot;)</span><br>    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">bankExecutor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();<br>        <span class="hljs-comment">// 设置核心线程数为 3</span><br>        executor.setCorePoolSize(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">// 最大线程数为10</span><br>        executor.setMaxPoolSize(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">// 任务队列的大小</span><br>        executor.setQueueCapacity(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">// 线程前缀名</span><br>        executor.setThreadNamePrefix(<span class="hljs-string">&quot;bankExecutor-&quot;</span>);<br>        <span class="hljs-comment">// 线程存活时间</span><br>        executor.setKeepAliveSeconds(<span class="hljs-number">30</span>);<br>        <span class="hljs-comment">// 初始化</span><br>        executor.initialize();<br>        <span class="hljs-keyword">return</span> executor;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建任务 <strong>@EnableAsync @Async</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownLoadTask</span> &#123;<br><br>    <span class="hljs-meta">@Async(&quot;bankThreadPool&quot;)</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/1 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">justDoIt</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始下载银行 A 的对账文件&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行 A 对账文件下载完成，进行解密操作&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行 A 对账文件下载解密完成&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Async(&quot;bankThreadPool&quot;)</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/1 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">justDoIt2</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始下载银行 B 的对账文件&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行 B 对账文件下载完成，进行解密操作&quot;</span>);<br>        log.info(<span class="hljs-string">&quot;银行 B 对账文件下载解密完成&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/16/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/image-20231116104653766.png" class="" title="image-20231116104653766"></li></ol><h2 id="动态定时任务"><a href="#动态定时任务" class="headerlink" title="动态定时任务"></a>动态定时任务</h2><ol><li><p>定义任务类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 动态定时任务实现步骤</span><br><span class="hljs-comment"> * 步骤1：定义定时任务 DownLoadTaskV3 类实现 SchedulingConfigurer 接口；</span><br><span class="hljs-comment"> * 步骤2：编写定时任务要执行的业务逻辑；</span><br><span class="hljs-comment"> * 步骤3：数据库中配置任务执行的具体时间规则，记住任务名称</span><br><span class="hljs-comment"> * 步骤4：根据任务名称从数据库获取 Cron 参数，设置任务触发器，触发任务执行。</span><br><span class="hljs-comment"> * （仅抛砖引玉，可作进一步的抽象）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DownLoadTaskV3</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SchedulingConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    TaskInfoMapper taskInfoMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureTasks</span><span class="hljs-params">(ScheduledTaskRegistrar taskRegistrar)</span> &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">// 步骤2：编写定时任务要执行的业务逻辑(可以进一步抽象)。</span><br>                log.info(<span class="hljs-string">&quot;V3-开始下载银行 C 的对账文件&quot;</span>);<br>                log.info(<span class="hljs-string">&quot;V3-银行 C 对账文件下载完成，进行解密操作&quot;</span>);<br>                log.info(<span class="hljs-string">&quot;V3-银行 C 对账文件下载解密完成&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 步骤 4：根据任务名称从数据库获取 Cron 参数，设置任务触发器，触发任务执行。</span><br>        <span class="hljs-type">Trigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Trigger</span>() &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 每一次任务触发，都会调用一次该方法</span><br><span class="hljs-comment">             * 然后重新获取下一次的执行时间</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">nextExecutionTime</span><span class="hljs-params">(TriggerContext triggerContext)</span> &#123;<br>                <span class="hljs-comment">// 方式一：执行时间硬编码</span><br>                <span class="hljs-comment">//String cron = &quot;0/1 * * * * ?&quot;;</span><br><br>                <span class="hljs-comment">// 方式二：动态获取执行时间（从数据库、redis 等都可以做任务执行时间的存储管理，本次以数据库为例）</span><br>                <span class="hljs-type">TaskInfo</span> <span class="hljs-variable">taskInfo</span> <span class="hljs-operator">=</span> taskInfoMapper.selectById(<span class="hljs-number">1</span>);<br><br>                <span class="hljs-type">String</span> <span class="hljs-variable">cron</span> <span class="hljs-operator">=</span> taskInfo.getCron();<br>                <span class="hljs-type">CronTrigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronTrigger</span>(cron);<br>                <span class="hljs-keyword">return</span> trigger.nextExecutionTime(triggerContext);<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">// 设置任务触发器，触发任务执行。</span><br>        taskRegistrar.addTriggerTask(task, trigger);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建任务信息表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `SC_TASK_INFO` (<br>  `id` <span class="hljs-type">int</span> unsigned <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;主键ID&#x27;</span>,<br>  `cron` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;定时执行&#x27;</span>,<br>  `job_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;任务名称&#x27;</span>,<br>  `status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;任务开启状态 0-关闭 2-开启&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;更新时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;定时任务表&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `SC_TASK_INFO` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;0/10 * * * * ?&#x27;</span>, <span class="hljs-string">&#x27;downLoadTaskV3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;2020-03-01 16:43:50&#x27;</span>, <span class="hljs-string">&#x27;2020-06-11 11:06:09&#x27;</span>);<br></code></pre></td></tr></table></figure></li><li><p>创建实体类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;SC_TASK_INFO&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskInfo</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String cron;<br>    <span class="hljs-keyword">private</span> String jobName;<br>    <span class="hljs-keyword">private</span> String status;<br>    <span class="hljs-keyword">private</span> Date createTime;<br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>声明Mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaskInfoMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;TaskInfo&gt; &#123;&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="集成Quarttz定时任务"><a href="#集成Quarttz定时任务" class="headerlink" title="集成Quarttz定时任务"></a>集成Quarttz定时任务</h2><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入 Quartz 依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>定义任务类</p><blockquote><p>可以通过实现 Job 接口来定义任务，也可以通过继承 QuartzJobBean 这个抽象类来定义任务，其实 QuartzJobBean 本身也实现了 Job 接口，其本质都是实现 Job 接口来定义任务。</p></blockquote></li></ol><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://cloud.tencent.com/developer/article/1947189">https://cloud.tencent.com/developer/article/1947189</a></p><p><a href="https://cloud.tencent.com/developer/article/1947191">https://cloud.tencent.com/developer/article/1947191</a></p><p><a href="https://cloud.tencent.com/developer/article/1947192">https://cloud.tencent.com/developer/article/1947192</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Quartz</tag>
      
      <tag>定时任务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>knife4j教程</title>
    <link href="/2023/11/15/knife4j%E6%95%99%E7%A8%8B/"/>
    <url>/2023/11/15/knife4j%E6%95%99%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p><a href="https://doc.xiaominfo.com/docs/action/springboot">官方文档</a></p><h2 id="Springboot框架集成Knife4j"><a href="#Springboot框架集成Knife4j" class="headerlink" title="Springboot框架集成Knife4j"></a>Springboot框架集成Knife4j</h2><ol><li><p>Maven依赖引入</p><p><code>Note:</code>注意引入版本与springboot版本关系</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建Swagger配置依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2WebMvc</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Knife4jConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean(value = &quot;defaultApi2&quot;)</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">defaultApi2</span><span class="hljs-params">()</span> &#123;<br>        Docket docket=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                        <span class="hljs-comment">//.title(&quot;swagger-bootstrap-ui-demo RESTful APIs&quot;)</span><br>                        .description(<span class="hljs-string">&quot;# swagger-bootstrap-ui-demo RESTful APIs&quot;</span>)<br>                        .termsOfServiceUrl(<span class="hljs-string">&quot;http://www.xx.com/&quot;</span>)<br>                        .contact(<span class="hljs-string">&quot;xx@qq.com&quot;</span>)<br>                        .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                        .build())<br>                <span class="hljs-comment">//分组名称</span><br>                .groupName(<span class="hljs-string">&quot;2.X版本&quot;</span>)<br>                .select()<br>                <span class="hljs-comment">//这里指定Controller扫描包路径</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.github.xiaoymin.knife4j.controller&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>        <span class="hljs-keyword">return</span> docket;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>代码示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(tags = &quot;首页模块&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@ApiImplicitParam(name = &quot;name&quot;,value = &quot;姓名&quot;,required = true)</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;向客人问好&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/sayHi&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">sayHi</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;name&quot;)</span>String name)</span>&#123;<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">&quot;Hi:&quot;</span>+name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>启动Spring Boot工程，在浏览器中访问：<code>http://localhost:8080/doc.html</code></p></li></ol><h2 id="待补充相关注解使用"><a href="#待补充相关注解使用" class="headerlink" title="待补充相关注解使用"></a>待补充相关注解使用</h2>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Knife4j</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Slf4j使用教程</title>
    <link href="/2023/10/21/Slf4j%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
    <url>/2023/10/21/Slf4j%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="1-单一项目（测试）"><a href="#1-单一项目（测试）" class="headerlink" title="1. 单一项目（测试）"></a>1. 单一项目（测试）</h3><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.16.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-simple<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Test Slf4j &#123;&#125;&quot;</span>, <span class="hljs-string">&quot;测试测试&quot;</span>);<br>        System.out.println(<span class="hljs-number">7777</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[main] INFO Test - Test Slf4j 测试测试<br></code></pre></td></tr></table></figure><h3 id="2-项目使用（项目集成）"><a href="#2-项目使用（项目集成）" class="headerlink" title="2. 项目使用（项目集成）"></a>2. 项目使用（项目集成）</h3><h4 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.16.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-log4j12<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="添加-log4j-properties文件"><a href="#添加-log4j-properties文件" class="headerlink" title="添加 log4j.properties文件"></a>添加 log4j.properties文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">### 设置###</span><br><span class="hljs-attr">log4j.rootLogger</span> = <span class="hljs-string">info,stdout,D,E</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### 输出信息到控制抬 ###</span><br><span class="hljs-attr">log4j.appender.stdout</span> = <span class="hljs-string">org.apache.log4j.ConsoleAppender</span><br><span class="hljs-attr">log4j.appender.stdout.Target</span> = <span class="hljs-string">System.out</span><br><span class="hljs-attr">log4j.appender.stdout.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-attr">log4j.appender.stdout.layout.ConversionPattern</span> = <span class="hljs-string">[%-5p] %d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; method:%l%n%m%n</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### 输出DEBUG 级别以上的日志到=logs/error.log ###</span><br><span class="hljs-attr">log4j.appender.D</span> = <span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span><br><span class="hljs-attr">log4j.appender.D.File</span> = <span class="hljs-string">logs/log.log</span><br><span class="hljs-attr">log4j.appender.D.Append</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">log4j.appender.D.Threshold</span> = <span class="hljs-string">DEBUG </span><br><span class="hljs-attr">log4j.appender.D.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-attr">log4j.appender.D.layout.ConversionPattern</span> = <span class="hljs-string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### 输出ERROR 级别以上的日志到=logs/error.log ###</span><br><span class="hljs-attr">log4j.appender.E</span> = <span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span><br><span class="hljs-attr">log4j.appender.E.File</span> =<span class="hljs-string">logs/error.log </span><br><span class="hljs-attr">log4j.appender.E.Append</span> = <span class="hljs-string">true</span><br><span class="hljs-attr">log4j.appender.E.Threshold</span> = <span class="hljs-string">ERROR </span><br><span class="hljs-attr">log4j.appender.E.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-attr">log4j.appender.E.layout.ConversionPattern</span> = <span class="hljs-string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br></code></pre></td></tr></table></figure><h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Test Slf4j &#123;&#125;&quot;</span>, <span class="hljs-string">&quot;测试测试&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>参考资料：<a href="https://juejin.cn/post/6921246140822192141">https://juejin.cn/post/6921246140822192141</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Slf4j</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git使用规范</title>
    <link href="/2023/09/07/Git%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/"/>
    <url>/2023/09/07/Git%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/</url>
    
    <content type="html"><![CDATA[<h1 id="Git使用规范"><a href="#Git使用规范" class="headerlink" title="Git使用规范"></a>Git使用规范</h1><h2 id="分支管理策略"><a href="#分支管理策略" class="headerlink" title="分支管理策略"></a>分支管理策略</h2><h3 id="主分支（master-main）"><a href="#主分支（master-main）" class="headerlink" title="主分支（master&#x2F;main）"></a>主分支（master&#x2F;main）</h3><blockquote><p>首先，代码库应该有一个、且仅有一个主分支。所有提供给用户使用的正式版本，都在这个主分支上发布。</p><p><strong>gitee默认创建master</strong></p><p><strong>github默认创建main</strong></p><p>版本库初始化以后，默认就是在主分支在进行开发</p></blockquote><img src="/2023/09/07/Git%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/1.png" class="" title="截屏2023-08-24 11.08.45"><h3 id="开发分支（develop）"><a href="#开发分支（develop）" class="headerlink" title="开发分支（develop）"></a>开发分支（develop）</h3><ul><li><p>说明</p><blockquote><p>分支只用来分布重大版本，日常开发应该在另一条分支上完成。我们把开发用的分支，叫做Develop。</p><p>此分支有我们自行创建</p></blockquote></li><li><p>创建命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">git checkout -b develop master # 基于主分支创建开发分支，并切换到开发分支<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">相当于：</span><br>git branch develop # 创建develop分支<br> <br>git checkout develop # 切换到develop分支<br></code></pre></td></tr></table></figure></li></ul><img src="/2023/09/07/Git%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/2.png" class="" title="截屏2023-08-24 11.13.40"><h3 id="开发步骤"><a href="#开发步骤" class="headerlink" title="开发步骤"></a>开发步骤</h3><ol><li><p>拉去最新develop分支代码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git pull origin develop<br></code></pre></td></tr></table></figure></li><li><p>进行开发，开发完成后提交develop分支代码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">git add .<br>git cz<br>git push origin develop<br></code></pre></td></tr></table></figure></li><li><p>开发完成后，进行将develop分支代码合并到主分支</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">git diff develop master # 合并之前，可以查看两分支的不同之处（可选命令）<br><br>git checkout master # 切换到主分支<br>git merge --no-ff develop # 将指定分支合并到当前分支<br><span class="hljs-meta prompt_"># </span><span class="language-bash">--no-ff 参数介绍：</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">默认情况下，Git执行<span class="hljs-string">&quot;快进式合并&quot;</span>（fast-farward merge），会直接将Master分支指向Develop分支</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用–no-ff参数后，会执行正常合并，在Master分支上生成一个新节点。为了保证版本演进的清晰，我们希望采用这种做法</span><br></code></pre></td></tr></table></figure></li><li><p>合并完成，提交即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">git pull -u origin master # 拉去最新主分支代码<br>git push -u origin master # 将提交的代码推送出去<br></code></pre></td></tr></table></figure></li><li><p>合并完成后，可以删除分支（develop日常保留，有临时分支时，完成临时分支开发后，可进行分支删除）（可选步骤）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git branch -d release # 删除release分支<br></code></pre></td></tr></table></figure></li></ol><h2 id="相关参考文档"><a href="#相关参考文档" class="headerlink" title="相关参考文档"></a>相关参考文档</h2><p>文档参考：</p><ul><li><a href="https://blog.csdn.net/Junna_zeng/article/details/116779206">Git分支管理策略</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git Commit提交规范</title>
    <link href="/2023/09/07/Git-Commit%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83/"/>
    <url>/2023/09/07/Git-Commit%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83/</url>
    
    <content type="html"><![CDATA[<h2 id="Git-Commit提交规范"><a href="#Git-Commit提交规范" class="headerlink" title="Git Commit提交规范"></a>Git Commit提交规范</h2><ol><li><p>进行全局安装cz</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install -g commitizen  # 系统将弹出上述type、scope等来填写<br>npm install -g cz-conventional-changelog # 用来规范提交信息<br></code></pre></td></tr></table></figure></li><li><p>安装完成后,项目文件夹内进行初始化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm init # 初始化npm<br>commitizen init cz-conventional-changelog --save --force --save-exact # 在项目内添加对应以来,以及初始化<br></code></pre></td></tr></table></figure></li><li><p>安装完成后使用git cz命令提交即可</p><img src="/2023/09/07/Git-Commit%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83/image-20230626150341169-4052049.png" class="" title="image-20230626150341169"><ul><li>type: <code>必填</code> commit 类型，有业内常用的字段，也可以根据需要自己定义<ul><li>feat 增加新功能</li><li>fix 修复问题&#x2F;BUG</li><li>style 代码风格相关无影响运行结果的</li><li>perf 优化&#x2F;性能提升</li><li>refactor 重构</li><li>revert 撤销修改</li><li>test 测试相关</li><li>docs 文档&#x2F;注释</li><li>chore 依赖更新&#x2F;脚手架配置修改等</li><li>workflow 工作流改进</li><li>ci 持续集成</li><li>types 类型定义文件更改</li><li>wip 开发中</li><li>undef 不确定的分类</li></ul></li><li>scope: commit 影响的范围, 比如某某组件、某某页面</li><li>subject: <code>必填</code> 简短的概述提交的代码，建议符合 50&#x2F;72 formatting</li><li>body: commit 具体修改内容, 可以分为多行, 建议符合 50&#x2F;72 formatting</li><li>footer: 其他备注, 包括 breaking changes 和 issues 两部分</li></ul></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Github+hexo搭建个人博客</title>
    <link href="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <url>/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="Github建立仓库"><a href="#Github建立仓库" class="headerlink" title="Github建立仓库"></a>Github建立仓库</h2><ol><li><p>登陆个人github账号</p></li><li><p>创建新的仓库</p><img src="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/image-20230906185656784.png" class="" title="image-20230906185656784"><img src="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/image-20230906185825727.png" class="" title="image-20230906185825727"></li></ol><h2 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">brew search npm</span><br>==&gt; Formulae<br>npm ✔   pnpm    nfpm    nim     nvm     tpm     rpm     qpm     gpm     cpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">brew install npm</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm -v</span><br>9.8.0<br></code></pre></td></tr></table></figure><h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install -g hexo-cli</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo -v</span><br>INFO  Validating config<br>hexo: 6.3.0<br>hexo-cli: 4.3.1<br>os: darwin 21.6.0 12.5<br><br>node: 20.5.1<br>acorn: 8.10.0<br>ada: 2.5.1<br>ares: 1.19.1<br>base64: 0.5.0<br>brotli: 1.0.9<br>cjs_module_lexer: 1.2.2<br>cldr: 43.1<br>icu: 73.2<br>llhttp: 8.1.1<br>modules: 115<br>napi: 9<br>nghttp2: 1.55.1<br>openssl: 3.1.2<br>simdutf: 3.2.14<br>tz: 2023c<br>undici: 5.22.1<br>unicode: 15.0<br>uv: 1.46.0<br>uvwasi: 0.0.18<br>v8: 11.3.244.8-node.10<br>zlib: 1.2.11<br></code></pre></td></tr></table></figure><h3 id="创建自己的blog目录，并进行初始化"><a href="#创建自己的blog目录，并进行初始化" class="headerlink" title="创建自己的blog目录，并进行初始化"></a>创建自己的blog目录，并进行初始化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo init my-blog</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> my-blog</span><br></code></pre></td></tr></table></figure><h3 id="修改主题"><a href="#修改主题" class="headerlink" title="修改主题"></a>修改主题</h3><p><a href="https://github.com/fluid-dev/hexo-theme-fluid">Fluid主题</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">my-blog/themes，克隆主题库</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/fluid-dev/hexo-theme-fluid.git</span><br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># my-blog/_config.yml，修改相关配置</span><br><span class="hljs-attr">theme:</span> <span class="hljs-string">hexo-theme-fluid</span> <span class="hljs-comment"># 修改主题</span><br><span class="hljs-attr">language:</span> <span class="hljs-string">zh-CN</span> <span class="hljs-comment"># 修改语言</span><br></code></pre></td></tr></table></figure><h3 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span><br></code></pre></td></tr></table></figure><p><strong>访问：localhost:4000</strong></p><img src="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/image-20230906191201353.png" class="" title="image-20230906191201353"><h2 id="配置github远程仓库"><a href="#配置github远程仓库" class="headerlink" title="配置github远程仓库"></a>配置github远程仓库</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">&#x27;git&#x27;</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">https://github.com/YueCang/yuecang.github.io.git</span><br>  <span class="hljs-attr">branch:</span> <span class="hljs-string">main</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">必填</span><br></code></pre></td></tr></table></figure><h2 id="部署到远程仓库"><a href="#部署到远程仓库" class="headerlink" title="部署到远程仓库"></a>部署到远程仓库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">部署之前需要安装部署工具</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install hexo-deployer-git --save</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo clean &amp; hexo g &amp; hexo d</span><br></code></pre></td></tr></table></figure><p><strong>访问：<a href="https://yuecang.github.io/">https://yuecang.github.io/</a></strong></p><img src="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/image-20230906191506323.png" class="" title="image-20230906191506323"><h2 id="相关问题解决"><a href="#相关问题解决" class="headerlink" title="相关问题解决"></a>相关问题解决</h2><h3 id="文章图片不显示"><a href="#文章图片不显示" class="headerlink" title="文章图片不显示"></a>文章图片不显示</h3><ol><li><p>安装插件,<strong>注意是img插件</strong>，而不是image插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install hexo-asset-img --save</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 修改为true</span><br><span class="hljs-attr">post_asset_folder:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p>配置 <strong>Typora</strong>偏好设置，如下图更改，此操作将图片文件保存路径: .&#x2F;${filename} 即保存到与 当前正在编辑的文件名相同的同级文,<strong>这样就不需要每次写文档都要更改图片路径了</strong></p><img src="/2023/09/06/Github-hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/image-20230906192211178.png" class="" title="image-20230906192211178"></li><li><p>重新部署即可</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Github</tag>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
